<!DOCTYPE html>
<html class="" lang="en"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            Notes on builds.sr.ht  &ndash;
        
        Duing Dev
    </title>

    
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=https://duing.dev/css/styles.6f7510796ff02c7dabd794e74edd5fe8768c226a0caad05f3838da994c532544d6915ce65b106ca5a210796f2936429e8446811360103cd082ad0dc245016d71.css integrity="sha512-b3UQeW/wLH2r15TnTt1f6HaMImoMqtBfODjamUxTJUTWkVzmWxBspaIQeW8pNkKehEaBE2AQPNCCrQ3CRQFtcQ==" />
<meta name="author" content="Eduardo Lemos Rocha" />

    
    
        <meta name="description" content="I quite like builds.sr.ht and want to share some of the reasons." />
    

<meta property="og:site_name"
    content='Duing Dev' />

    <meta property="og:title" content="Notes on builds.sr.ht" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="Eduardo Lemos Rocha" />
    <meta
        property="article:published_time"
        content='2022-04-29T00:00:00Z&#43;0000' />
    
    <meta property="og:url" content="https://duing.dev/blog/notes-on-buildssrht/" />
    
    
    <meta property="og:image"
        content="https://duing.dev/img/icon.svg" />
    
        <meta property="og:description" content="I quite like builds.sr.ht and want to share some of the reasons." />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='duing.dev'
/>
<meta property="twitter:url" content="https://duing.dev/blog/notes-on-buildssrht/" />


    <meta name="twitter:title" content="Notes on builds.sr.ht" />
    
    
    
    <meta name="twitter:image"
        content="https://duing.dev/img/icon.svg" />
    
        <meta name="twitter:description" content="I quite like builds.sr.ht and want to share some of the reasons." />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">Duing Dev</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
            <li><a href="/about/">About</a></li>
        
        
            <li><a href="/tags">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <a class="nerdlink" onclick="newSearch();">&#xf002;</a>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="mailto:dudulr10@gmail.com">
    
    
        &#xf6ed;
    
    <span>
        Email
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/EduardoLR10">
    
    
        &#xf09b;
    
    <span>
        GitHub
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/eduardo-lemos-rocha-3198a5149/">
    
    
        &#xf0e1;
    
    <span>
        Linkedin
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.youtube.com/channel/UCMyzdYsPiBU3xoqaOeahr6Q">
    
    
        &#xf16a;
    
    <span>
        Dr.Nekoma
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>Notes on builds.sr.ht</h1>
    
    
        <p class="date">
            <span title='Date'>ï—¬ </span>
    2022-04-29

</p>
    
    
    
    
    <div><p>For the past few months I&rsquo;ve been using <a href="https://sr.ht">sourcehut</a>&rsquo;s platform to work on software
an it has been quite an interesting experience. Nonetheless, one of the services
I really enjoy using is the their build service called <a href="https://builds.sr.ht">builds.sr.ht</a>.</p>
<blockquote>
<p>builds.sr.ht is a service on sr.ht that allows you to submit &ldquo;build manifests&rdquo;
for us to work on. &ndash; <a href="https://man.sr.ht/builds.sr.ht/">man.sr.ht</a></p>
</blockquote>
<p>The thing I don&rsquo;t like on <a href="https://github.com/features/actions">GitHub Actions</a> is that it is kind of <em>magical</em>. For
example, you don&rsquo;t actually know what it is doing when you define that an
<code>action</code> should only run when a specific path is modified. Not to even mention
their <a href="https://docs.github.com/pt/actions/creating-actions">custom actions</a> which usually takes a non-trivial amount of
TypeScript/JavaScript.</p>
<p>Contrary to this, <a href="https://builds.sr.ht">builds.sr.ht</a> is <em>really</em> explicit on its <a href="https://man.sr.ht/builds.sr.ht/manifest.md">build manifest</a>.
You&rsquo;re basically expected to write plain shell scripts for your builds.</p>
<h2 id="reducing-resource-usage">Reducing resource usage</h2>
<p>As I said previously, there&rsquo;s no special syntax to work on specific paths,
branches, pull requests and such. By default your task will run on every commit
you push. In order to reduce our CI usage we can restrain our tasks to run on
specific scenarios:</p>
<h3 id="on-path-change">On path change</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! <span style="color:#66d9ef">$(</span>git diff --quiet HEAD HEAD^ -- <span style="color:#e6db74">&#34;&lt;your-path&gt;&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># do something</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span></code></pre></div><h3 id="on-branch-change">On branch change</h3>
<p>This tip was taken from <a href="https://todo.sr.ht/~sircmpwn/builds.sr.ht/170">issue #170</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">check-branch</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   cd repo_name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   if [ &#34;$(git rev-parse your-branch)&#34; != &#34;$(git rev-parse HEAD)&#34; ]; then \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      complete-build; \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   fi</span>   
</span></span></code></pre></div><h2 id="nixos-on-builds.sr.ht">NixOS on builds.sr.ht</h2>
<p>As I don&rsquo;t like to write shell scripts I use Nix and this is my favorite feature
of this service. builds.sr.ht supports <a href="https://nixos.org">NixOS</a> by default<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. This means that
we can leverage Nix Flakes for truly declarative and reproducible builds there!
Let&rsquo;s consider a small example using <a href="https://go.dev">Go</a> to show you how easy it really is. A
small <code>flake.nix</code> containing the following content should suffice our needs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nix" data-lang="nix"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  inputs<span style="color:#f92672">.</span>nixpkgs<span style="color:#f92672">.</span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;github:nixos/nixpkgs/nixos-unstable&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  outputs <span style="color:#f92672">=</span> { self<span style="color:#f92672">,</span> nixpkgs<span style="color:#f92672">,</span> <span style="color:#f92672">...</span> }:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> pkgs <span style="color:#f92672">=</span> <span style="color:#f92672">import</span> nixpkgs { system <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;x86_64-linux&#34;</span>; };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">in</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      devShells<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;x86_64-linux&#34;</span><span style="color:#f92672">.</span>ci <span style="color:#f92672">=</span> <span style="color:#66d9ef">with</span> pkgs; mkShell {
</span></span><span style="display:flex;"><span>        buildInputs <span style="color:#f92672">=</span> [ go golangci-lint ];
</span></span><span style="display:flex;"><span>      };
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This definition is capable of giving us a shell containing Go and <a href="https://github.com/golangci/golangci-lint">golangci-lint</a>
on <code>$PATH</code>.</p>
<p>Now let&rsquo;s write the build manifest for our CI:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">image</span>: <span style="color:#ae81ff">nixos/unstable</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">packages</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">nixos.nixUnstable</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">NIX_CONFIG</span>: <span style="color:#e6db74">&#34;experimental-features = nix-command flakes&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">tasks</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">lint</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cd source
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nix develop .#ci -c golangci-lint run</span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">test</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cd source
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nix develop .#ci -c go test ./...</span>      
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">build</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      cd source
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      nix develop .#ci -c go build</span>      
</span></span></code></pre></div><p>And that&rsquo;s it! We have our CI up and running with the guarantee of having our
tools being the same on every run. No sudden updates or unexpected behavior.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://nixos.org">https://nixos.org</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</div>
</article>






                    </main><footer>
    <hr />

<p><small>
        2023 &copy; 
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
