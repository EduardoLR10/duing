<!DOCTYPE html>
<html class="" lang="en"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            write: broken pipe  &ndash;
        
        Duing Dev
    </title>

    
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=https://duing.dev/css/styles.6f7510796ff02c7dabd794e74edd5fe8768c226a0caad05f3838da994c532544d6915ce65b106ca5a210796f2936429e8446811360103cd082ad0dc245016d71.css integrity="sha512-b3UQeW/wLH2r15TnTt1f6HaMImoMqtBfODjamUxTJUTWkVzmWxBspaIQeW8pNkKehEaBE2AQPNCCrQ3CRQFtcQ==" />
<meta name="author" content="Eduardo Lemos Rocha" />

    
    
        <meta name="description" content="  The adventure of figuring out the &#34;tcp: write: broken pipe&#34; error.
  " />
    

<meta property="og:site_name"
    content='Duing Dev' />

    <meta property="og:title" content="write: broken pipe" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="Eduardo Lemos Rocha" />
    <meta
        property="article:published_time"
        content='2022-04-06T00:00:00Z&#43;0000' />
    
    <meta property="og:url" content="https://duing.dev/blog/write-broken-pipe/" />
    
    
    <meta property="og:image"
        content="https://duing.dev/img/icon.svg" />
    
        <meta property="og:description" content="  The adventure of figuring out the &#34;tcp: write: broken pipe&#34; error.
  " />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='duing.dev'
/>
<meta property="twitter:url" content="https://duing.dev/blog/write-broken-pipe/" />


    <meta name="twitter:title" content="write: broken pipe" />
    
    
    
    <meta name="twitter:image"
        content="https://duing.dev/img/icon.svg" />
    
        <meta name="twitter:description" content="  The adventure of figuring out the &#34;tcp: write: broken pipe&#34; error.
  " />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">Duing Dev</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
        
            <li><a href="/about/">About</a></li>
        
        
            <li><a href="/tags">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        <div class="search">
    <input id="searchbar" type="text" placeholder='Search' />
    <a class="nerdlink" onclick="newSearch();">&#xf002;</a>
</div>
<script>
    function newSearch() {
        let term = searchbar.value.trim();
        if (!term) return;
        location.href = `/search?q=${term}`;
    }
    searchbar.onkeyup = (ev) => {if (ev.keyCode == 13) newSearch()};
</script>

    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="mailto:dudulr10@gmail.com">
    
    
        &#xf6ed;
    
    <span>
        Email
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/EduardoLR10">
    
    
        &#xf09b;
    
    <span>
        GitHub
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/eduardo-lemos-rocha-3198a5149/">
    
    
        &#xf0e1;
    
    <span>
        Linkedin
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.youtube.com/channel/UCMyzdYsPiBU3xoqaOeahr6Q">
    
    
        &#xf16a;
    
    <span>
        Dr.Nekoma
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>write: broken pipe</h1>
    
    
        <p class="date">
            <span title='Date'>ï—¬ </span>
    2022-04-06

</p>
    
    
    
    
    <div><p><strong>tl;dr</strong>: <a href="https://docs.konghq.com/kubernetes-ingress-controller/">Kong Ingress Controller</a> was the culprit. Its timeout setting was
closing the connection before the file could be sent. /If you&rsquo;re facing this
issue in a long-lasting request, check your reverse proxy configuration, as it
may have a different configuration than your application./ ;-)</p>
<p>At Grupo SBF we have an HTTP server written in <a href="https://go.dev/">Go</a> that queries <a href="https://cloud.google.com/bigquery">BigQuery</a> and
returns the result as a <strong>big</strong> csv file. However, after some time we sent a
request and instead of a file, we received this error message:</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">write tcp 10.0.0.1:8080-&gt;10.0.0.2:38302: write: broken pipe
</code></pre><p>Well, this is quite a surprise as we haven&rsquo;t seen this error message before&hellip;
After all, what does it even mean? A quick Google search returned this:</p>
<blockquote>
<p>A condition in programming (also known in POSIX as EPIPE error code and SIGPIPE
signal), when a process requests an output to pipe or socket, which was closed
by peer. &ndash; <a href="https://en.wikipedia.org/wiki/Broken_pipe">Wikipedia</a></p>
</blockquote>
<p>Hmm, this <em>definitely</em> shed some light on the problem. Considering that the HTTP
server is provided by the powerful <a href="https://pkg.go.dev/net/http">net/http</a> package in Go&rsquo;s standard library, we
might have some obvious places to check out.</p>
<p>Cloudflare has a <a href="https://blog.cloudflare.com/exposing-go-on-the-internet/">great article</a> talking about the default configuration on Go&rsquo;s
HTTP server and how to avoid making mistakes with them. We jumped straight to
the article&rsquo;s timeout section and checked if we didn&rsquo;t forget to configure them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ReadTimeout</span>:  <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>, <span style="color:#75715e">// 10 minutes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">WriteTimeout</span>: <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Addr</span>:         <span style="color:#e6db74">&#34;:8080&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Handler</span>:      <span style="color:#a6e22e">r</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For context, our application takes about 2 minutes to send a response so this
isn&rsquo;t a problem for us as we have 10 minutes until a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/504">504 server error</a> is
returned.</p>
<p>To our amazement, sending the request to a local server returned no error
whatsoever. Comparing our local environment with production we also noticed that
our request was <em>dropped</em> at exactly 1 minute of execution in production.
Therefore it must be something between our client and server!</p>
<p>Knowing that we deploy to a Kubernetes cluster with a <a href="https://docs.konghq.com/kubernetes-ingress-controller/">Kong Ingress Controller</a>
_{controlling} taking care of our reverse proxy, we checked its documentation
and&hellip; Bingo! This is the root of our problem, as per the <a href="https://docs.konghq.com/gateway/1.1.x/reference/proxy/#3-proxying-and-upstream-timeouts">Kong Ingress
Controller Documentation</a> the default timeout is <code>60_000</code> milliseconds &ndash; in
other words, 1 minute!</p>
<h2 id="replicating-the-behavior">Replicating the behavior</h2>
<p>Before trying something on our servers, why don&rsquo;t we replicate this behavior
locally? For this purpose we can run a <code>nginx</code> container and a simple Go HTTP
server with a similar functionality of our service.</p>
<p>The idea behind the test is to setup an endpoint that takes a lot of time
writing on the buffer while our reverse proxy has a timeout of only 2 seconds.</p>
<h3 id="go-server-and-dockerfile">Go server and Dockerfile</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mux</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// creating a large data size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// that will take a long time to be written
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">size</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">900</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tpl</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">size</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;page&#34;</span>).<span style="color:#a6e22e">Parse</span>(string(<span style="color:#a6e22e">tpl</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;error parsing template: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Execute</span>(<span style="color:#a6e22e">w</span>, <span style="color:#66d9ef">nil</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;error writing: %s&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ReadTimeout</span>: <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">WriteTimeout</span>: <span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Addr</span>: <span style="color:#e6db74">&#34;:8080&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Handler</span>: <span style="color:#a6e22e">mux</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;server is running!&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">ListenAndServe</span>())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And then the Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># server.Dockerfile</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> golang:alpine AS build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk --no-cache add gcc g++ make git<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /go/src/app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go mod init server<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> go mod tidy<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> GOOS<span style="color:#f92672">=</span>linux go build -ldflags<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-s -w&#34;</span> -o ./bin/web-app ./server.go<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine:3.13</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk --no-cache add ca-certificates<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /usr/bin</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>build /go/src/app/bin /go/bin<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> /go/bin/web-app --port <span style="color:#ae81ff">8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="nginx-configuration-and-dockerfile">nginx configuration and Dockerfile</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cfg" data-lang="cfg"><span style="display:flex;"><span><span style="color:#75715e"># nginx.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">events {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">worker_connections 1024;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">http {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">server_tokens off;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">server {</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">listen 80;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">location / {</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">proxy_set_header X-Forwarded-For $remote_addr;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">proxy_set_header Host            $http_host;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># timeout set to 2 seconds</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">proxy_read_timeout 2s;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">proxy_connect_timeout 2s;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">proxy_send_timeout 2s;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">proxy_pass http://goservice:8080/;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">}</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">}</span>
</span></span></code></pre></div><p>And then the Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#75715e"># nginx.Dockerfile</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> nginx:latest</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> nginx.conf /etc/nginx/nginx.conf<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h3 id="docker-compose">Docker Compose</h3>
<p>The last piece missing is a <a href="https://docs.docker.com/compose/">Docker
Compose</a> file to help us run these containers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># docker-compose.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#34;3.6&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">goservice</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#e6db74">&#34;server.Dockerfile&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nginx</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>: <span style="color:#e6db74">&#34;nginx.Dockerfile&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;80:80&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;goservice&#34;</span>
</span></span></code></pre></div><h3 id="running-and-testing">Running and testing</h3>
<p>After setting up our environment we can test it by running the commands below:</p>
<ul>
<li><code>docker-compose up --build</code> to run our containers</li>
<li><code>curl localhost</code> to make a request to our server</li>
</ul>
<p>VoilÃ¡! The error shows up confirming our theory!</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">goservice_1  | 2022/04/07 01:12:14 error writing: write tcp 172.18.0.2:8080-&gt;172.18.0.3:56768: write: broken pipe
</code></pre><h2 id="conclusion">Conclusion</h2>
<p>This was a lot of fun to figure it! As noted by our tests the timeout
configuration of our cluster&rsquo;s reverse proxy was indeed the issue, overriding
the timeout settings with the snippet below solved the issue instantly!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">configuration.konghq.com/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">KongIngress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kubernetes.io/ingress.class</span>: <span style="color:#e6db74">&#34;kong&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">kong-timeout-conf</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">proxy</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">connect_timeout</span>: <span style="color:#ae81ff">10000000</span> <span style="color:#75715e"># 10 minutes</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">read_timeout</span>: <span style="color:#ae81ff">10000000</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">write_timeout</span>: <span style="color:#ae81ff">10000000</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">annotations</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">konghq.com/override</span>: <span style="color:#ae81ff">kong-timeout-conf</span>
</span></span></code></pre></div></div>
</article>






                    </main><footer>
    <hr />

<p><small>
        2023 &copy; 
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
