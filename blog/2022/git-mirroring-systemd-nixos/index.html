<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  Git mirroring, systemd and NixOS

    </title>
    
    <link rel="stylesheet" href="/css/main.min.2b661d17033c8e88dcb9551cb00d5235c93175108db6ef12ccc009cce52bdd00.css" /><meta property="og:title" content="Git mirroring, systemd and NixOS" />
<meta property="og:description" content="Configuring a Git mirror with systemd services and timers on NixOS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://glorifiedgluer.com/blog/2022/git-mirroring-systemd-nixos/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-06-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-06-14T00:00:00+00:00" />

</head>
  <body><nav>
  <img
    src="/img/nana-icons/shiba-computer-low.jpg"
    alt="A shiba using the computer"
    width="128"
    height="128"
  />
  <h1>~glorifiedgluer</h1>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/blogroll">Blogroll</a></li>
  </ul>
</nav>
<main>
  <h2>Git mirroring, systemd and NixOS
    <small>
      <time>June 14, 2022</time>
    by ~glorifiedgluer


    </small>
  </h2><p>For the past few years I have been collecting contributions to multiple projects
on multiple platforms such as GitHub, GitLab, self-hosted Gitea instances and so
on. It&rsquo;s rather boring to go to a website and see the source code there&hellip; Then
I thought to myself: &ldquo;Why not write about a made up need I don&rsquo;t have just to
learn something new?&rdquo;.</p>
<p>So, the idea here was to mirror those repositories into my <a href="https://sourcehut.org">sourcehut</a> account
(although this should work for any remote repository). For this we will use a
<a href="https://nixos.org">NixOS</a> system and <a href="https://www.freedesktop.org/software/systemd/man/systemd.timer.html">systemd timers</a>. The idea is dead simple, we clone the
repositories and push them to our desired remote.</p>
<h2 id="configuring-the-repository">Configuring the repository</h2>
<p>This step is pretty easy and can be done in two steps:</p>
<ol>
<li>Clone the repository</li>
</ol>
<!--listend-->
<div class="highlight">
    <span class="highlight-type">sh</span>
    <pre><code class="language-sh hljs" data-lang="sh">$ git clone --mirror https://git.com/repo</code></pre>
</div>

<style>
    .highlight-type {
        content: "sh";
        position: absolute;
        opacity: 0.5;
    }
</style><ol>
<li>Configure the remote as to ensure that we will only push to the
desired remote.</li>
</ol>
<!--listend-->
<div class="highlight">
    <span class="highlight-type">sh</span>
    <pre><code class="language-sh hljs" data-lang="sh">$ cd repo
$ git remote set-url --push origin https://remote.com/repo-mirror</code></pre>
</div>

<style>
    .highlight-type {
        content: "sh";
        position: absolute;
        opacity: 0.5;
    }
</style><h2 id="systemd-to-the-rescue">systemd to the rescue</h2>
<p>We have our repository but we are still missing an important step that is to
keep pushing new changes to our mirror.</p>
<p><a href="https://nixos.org">NixOS</a> has a pretty good declarative way of declaring systemd services and timers
that we can take advantage of here. The idea is to have a script being ran in
our diretory through a systemd <em>service</em> that will be invoked by a systemd
<em>timer</em> hourly.</p>
<h3 id="the-script">The script</h3>
<p>There&rsquo;s nothing novel here. This script will iterate over the directories inside
the <code>WorkingDirectory</code>, fetch updates and then push it to our mirror.</p>
<div class="highlight">
    <span class="highlight-type">nix</span>
    <pre><code class="language-nix hljs" data-lang="nix">let
  gitmirrorScript = pkgs.writeShellScriptBin &#34;gitmirror&#34; &#39;&#39;
    for d in */ ; do
      git -C &#34;$d&#34; fetch -p origin
      git -C &#34;$d&#34; push --mirror
    done
  &#39;&#39;;
in</code></pre>
</div>

<style>
    .highlight-type {
        content: "nix";
        position: absolute;
        opacity: 0.5;
    }
</style><h3 id="the-service-and-timer">The service and timer</h3>
<p>The service is rather simple too, we pass our repository&rsquo;s directory through the
<code>WorkingDirectory</code> value and set the <code>gitmirror</code> service as the unit to be
invoked by our timer. Note, however, that we added <code>git</code> <em>and</em> <code>openssh</code> to the
path. Your root user should be able to authenticate on boths repos with its ssh
key.</p>
<div class="highlight">
    <span class="highlight-type">nix</span>
    <pre><code class="language-nix hljs" data-lang="nix">{
  systemd.services.gitmirror = {
    enable = true;
    description = &#34;Git mirror service&#34;;
    after = [ &#34;network.target&#34; ];
    path = with pkgs; [ git openssh ];
    serviceConfig = {
      Type=&#34;oneshot&#34;;
      WorkingDirectory = &#34;/home/glorifiedgluer/repo&#34;;
      ExecStart = &#34;${gitmirrorScript}/bin/gitmirror&#34;;
    };
    wantedBy = [ &#34;multi-user.target&#34; ];
  };

  systemd.timers.gitmirror = {
    description = &#34;Git mirror timer&#34;;
    timerConfig = {
      OnCalendar = &#34;hourly&#34;;
      Unit = &#34;gitmirror.service&#34;;
    };
    wantedBy = [ &#34;timers.target&#34; ];
  };
}</code></pre>
</div>

<style>
    .highlight-type {
        content: "nix";
        position: absolute;
        opacity: 0.5;
    }
</style><footer>
    <p><em>
        Have something to say about this? Feel free to send me an email at
        <a href="mailto:~glorifiedgluer/inbox@lists.sr.ht">my inbox</a>!
    </em></p>
</footer>

      </main>
    </main>
  </body>
</html>
