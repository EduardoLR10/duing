<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  Building a Dell PowerEdge T410 NAS with NixOS and ZFS

    </title>
    
    <link rel="stylesheet" href="/css/main.min.2b661d17033c8e88dcb9551cb00d5235c93175108db6ef12ccc009cce52bdd00.css" /><meta property="og:title" content="Building a Dell PowerEdge T410 NAS with NixOS and ZFS" />
<meta property="og:description" content="My journey into the sysadmin rabbithole with a personal NAS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://glorifiedgluer.com/blog/2022/building-a-dell-poweredge-t410-nas-with-nixos-and-zfs/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-09-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-09-06T00:00:00+00:00" />

</head>
  <body><nav>
  <img
    src="/img/nana-icons/shiba-computer-low.jpg"
    alt="A shiba using the computer"
    width="128"
    height="128"
  />
  <h1>~glorifiedgluer</h1>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/blogroll">Blogroll</a></li>
  </ul>
</nav>
<main>
  <h2>Building a Dell PowerEdge T410 NAS with NixOS and ZFS
    <small>
      <time>September 6, 2022</time>
    by ~glorifiedgluer


    </small>
  </h2><p>For some time I&rsquo;ve been thinking about getting a NAS for personal usage.
However, most of the <em>prebuilt</em> solutions are too expensive here and they don&rsquo;t
even come with hard drives&hellip; I then decided to research a cheap way to build it
my own.</p>
<p>One famous guide for home-built NAS is the <a href="https://forums.serverbuilds.net/t/guide-nas-killer-5-0/3072">NAS KILLER</a> series by <a href="https://old.reddit.com/user/JDM_WAAAT/">u/JDM_WAAAT</a>. I
tried to find most of the parts shown there but I always missed one as it was
either not available or couldn&rsquo;t be shipped here. This way my only choice was to
look at the prebuilt options they mention on the series. I saw a mention of some
models of Dell PowerEdges and decided to take a look at the local second-hand
market.</p>
<p>There it was, a Dell PowerEdge T410 for R\$400 (equivalent of \$75) including
shipping. Such a steal considering that they go fora bout  R\$3.5k here! The
specs are the following:</p>
<table>
<thead>
<tr>
<th>Host</th>
<th>Dell PowerEdge 410</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU</td>
<td>Intel Xeon X5660 (12) @ 1.596GHz</td>
</tr>
<tr>
<td>GPU</td>
<td>Matrox Electronics Systems Ltd. PowerEdge T410</td>
</tr>
<tr>
<td>Memory</td>
<td>32GB DDR3 ECC 1600MHz</td>
</tr>
</tbody>
</table>
<p>You can see the whole cost of this setup below:</p>
<table>
<thead>
<tr>
<th>Date (in days)</th>
<th>Item</th>
<th>Price (R$)</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="timestamp-wrapper"><span class="timestamp">&lt;2022-09-07 Wed&gt;</span></span></td>
<td>Dell PowerEdge T410 <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></td>
<td>400</td>
</tr>
<tr>
<td><span class="timestamp-wrapper"><span class="timestamp">&lt;2022-09-07 Wed&gt;</span></span></td>
<td><a href="https://pt.aliexpress.com/item/1005004253108255.html">Dell PERC H200</a> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></td>
<td>166.96</td>
</tr>
<tr>
<td><span class="timestamp-wrapper"><span class="timestamp">&lt;2022-09-09 Fri&gt;</span></span></td>
<td><a href="https://produto.mercadolivre.com.br/MLB-2199914105-hdd-dell-4tb-sas-6gbps-rpm-72k-35-st4000nm0023-pn-0drmyh-_JM">5x Seagate ST4000NM0023 4TB</a> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></td>
<td>4455</td>
</tr>
<tr>
<td><span class="timestamp-wrapper"><span class="timestamp">&lt;2022-10-20 Thu&gt;</span></span></td>
<td><a href="https://pt.aliexpress.com/item/32840300151.html">32GB 1600MHz RAM DDR3 ECC (16x2)</a></td>
<td>161.51</td>
</tr>
<tr>
<td>43</td>
<td></td>
<td>5183.47</td>
</tr>
</tbody>
</table>
<h2 id="upgrading-the-poweredge-raid-controller--perc">Upgrading the PowerEdge RAID Controller (PERC)</h2>
<p>Unfortunately my server came with a <a href="https://www.dell.com/support/kbdoc/en-us/000131648/list-of-poweredge-raid-controller-perc-types-for-dell-emc-systems">Dell PERC 6/I</a> which only supports disks as
big as 2TB. Doing some research over the internet I found out that I had two
options of upgrades here: H200 or H700.</p>
<p>As I&rsquo;m going to use ZFS as my filesystem, I went with H200 because I can just
use it in IT mode (as JBOD) making it possible to pass all the drives directly
to my ZFS pool without the hardware interfering much.</p>
<p>Now something that I want to confess here&hellip; I was afraid to buy this server and
have to pay enterprise prices for hardware or even restrict my ability to
expand/replace the system. However, I learned that I can use my new H200 PERC on
a regular desktop<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> with some special cables you can buy for cheap so I
might even be able to build a smaller machine with the same amount of disks and
a more balanced power/comsuption ratio.</p>
<h2 id="setting-up-ssh">Setting up SSH</h2>
<p>The first thing I do on the NixOS installation media is to change the <code>nixos</code>
user password to proceed the installation in another computer:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">$ passwd

# over the other computer
$ ssh nixos@&lt;ip&gt;</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><h2 id="configuring-the-disks">Configuring the disks</h2>
<p>Fortunately, using ZFS with NixOS is a breeze. It has a really good support and
I can even boot from a ZFS pool. Let&rsquo;s start by listing the disks and getting
their IDs:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">[nixos@nixos:~]$ ls -al /dev/disk/by-id/
total 0
drwxr-xr-x 2 root root 340 Nov  2 15:12 .
drwxr-xr-x 7 root root 140 Nov  2 14:54 ..
lrwxrwxrwx 1 root root   9 Nov  2 15:12 scsi-35000c500571d23bf -&gt; ../../sdb
lrwxrwxrwx 1 root root   9 Nov  2 15:12 scsi-35000c500964ac36f -&gt; ../../sdd
lrwxrwxrwx 1 root root   9 Nov  2 15:12 scsi-35000c500964b5e7b -&gt; ../../sdc
lrwxrwxrwx 1 root root   9 Nov  2 15:12 scsi-35000c500964b723b -&gt; ../../sdf
lrwxrwxrwx 1 root root   9 Nov  2 15:12 scsi-35000c500964bbbd3 -&gt; ../../sde</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><p>We should use the disks IDs on our ZFS pool, this will avoid some headaches in
the future as switching the HDs bays and ZFS losing tracks of which disk is
which. Ok, now that we have the IDs, let&rsquo;s wipe them to make sure we don&rsquo;t have
any filesystems on them already.</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">DISK1=/dev/disk/by-id/scsi-35000c500571d23bf
DISK2=/dev/disk/by-id/scsi-35000c500964ac36f
DISK3=/dev/disk/by-id/scsi-35000c500964b5e7b
DISK4=/dev/disk/by-id/scsi-35000c500964b723b
DISK5=/dev/disk/by-id/scsi-35000c500964bbbd3

sudo wipefs -af $DISK1
sudo wipefs -af $DISK2
sudo wipefs -af $DISK3
sudo wipefs -af $DISK4
sudo wipefs -af $DISK5</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><p>Now the last bit missing is the partition layout:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo sgdisk -n3:1M:&#43;512M -t3:EF00 $DISK1
sudo sgdisk -n1:0:0 -t1:BF01 $DISK1</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><p>After this we just copy it to the other drives:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo sfdisk --dump $DISK1 | sudo sfdisk $DISK2
sudo sfdisk --dump $DISK1 | sudo sfdisk $DISK3
sudo sfdisk --dump $DISK1 | sudo sfdisk $DISK4
sudo sfdisk --dump $DISK1 | sudo sfdisk $DISK5</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><h3 id="formatting">Formatting</h3>
<h4 id="boot">Boot</h4>
<p>Starting with the boot partition:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo mkfs.vfat $DISK1-part3
sudo mkfs.vfat $DISK2-part3
sudo mkfs.vfat $DISK3-part3
sudo mkfs.vfat $DISK4-part3
sudo mkfs.vfat $DISK5-part3</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><h4 id="zfs">ZFS</h4>
<p>Considering that I want two disk parity on my setup, I&rsquo;m going with a <em>raidz2</em> pool.</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo zpool create -o ashift=12 \
                  -O dnodesize=auto \
                  -O normalization=formD \
                  -O relatime=on \
                  -O acltype=posixacl \
                  -O xattr=sa \
                  -O mountpoint=none \
                  -O compression=lz4 \
                  -O recordsize=1M \
                  zroot raidz2 \
                  $DISK1-part1 $DISK2-part1 $DISK3-part1 $DISK4-part1 $DISK5-part1</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><p>And the following datasets:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo zfs create -o mountpoint=none zroot/root
sudo zfs create -o mountpoint=legacy zroot/root/nixos
sudo zfs create -o mountpoint=legacy zroot/var
sudo zfs create -o mountpoint=legacy zroot/var/media
sudo zfs create -o mountpoint=legacy zroot/var/torrents
sudo zfs create -o mountpoint=legacy zroot/var/samba
sudo zfs create -o mountpoint=legacy zroot/home</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><h3 id="mounting-everything-together">Mounting everything together</h3>
<p>Mounting is the easiest part of the whole process. However, we need the directories to be there in the first place.</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo mount -t zfs zroot/root/nixos /mnt
sudo mkdir /mnt/home
sudo mkdir -p /mnt/var/lib/{torrents,media,samba}
sudo mkdir /mnt/boot</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><p>Now it&rsquo;s just a matter of <em>mapping</em> everything to the right place:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo mount -t zfs zroot/home /mnt/home
sudo mount -t zfs zroot/var /mnt/var
sudo mount -t zfs zroot/var/media /mnt/var/lib/media
sudo mount -t zfs zroot/var/torrents /mnt/var/lib/torrents
sudo mount -t zfs zroot/var/samba /mnt/var/lib/samba
sudo mount $DISK1-part3 /mnt/boot</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><h2 id="finishing-up">Finishing up</h2>
<p>The only step left is to generate the NixOS configuration with the filesystem layout and install the system:</p>
<div class="highlight">
    <span class="highlight-type">shell</span>
    <pre><code class="language-shell hljs" data-lang="shell">sudo nixos-generate-config --root /mnt

# don&#39;t forget to get your machine id and put it on `networking.hostId`
head -c 8 /etc/machine-id

sudo nixos-install</code></pre>
</div>

<style>
    .highlight-type {
        content: "shell";
        position: absolute;
        opacity: 0.5;
    }
</style><div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>This hardware is actually overkill for this build but I couldn&rsquo;t find anything better for such a price.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Unfortunately my machine arrived with a Dell PERC 6/i that has a 2TB per disk limit.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>Unfortunately hard drives are <strong>really</strong> expensive in Brazil due to taxes&hellip; a ~$35 drive costing near $200 is just insane!&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>A lot of people use the LSI 9240-8I HBA on regular desktops.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
<footer>
    <p><em>
        Have something to say about this? Feel free to send me an email at
        <a href="mailto:~glorifiedgluer/inbox@lists.sr.ht">my inbox</a>!
    </em></p>
</footer>

      </main>
    </main>
  </body>
</html>
