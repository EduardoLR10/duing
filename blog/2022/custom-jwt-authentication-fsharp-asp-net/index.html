<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  Custom JWT Authentication with F# and ASP.NET

    </title>
    
    <link rel="stylesheet" href="/css/main.min.2b661d17033c8e88dcb9551cb00d5235c93175108db6ef12ccc009cce52bdd00.css" /><meta property="og:title" content="Custom JWT Authentication with F# and ASP.NET" />
<meta property="og:description" content="At my $CURRENT_JOB we are working on introducing a new back-end service, and as usual, teams entirely composed of new-ish employees face some hard time discovering all the small pieces required to make the gears turn.
This time the challenge was to implement the authentication layer. It is actually quite simple as it is just a regular JWT token, but the devil&rsquo;s in the details:
 the token is on a custom header called `x-jwt-payload` the token does not contain the alg attribute the validation is done internally at the reverse proxy level  OK, this doesn&rsquo;t sound too bad." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://glorifiedgluer.com/blog/2022/custom-jwt-authentication-fsharp-asp-net/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-12-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-12-20T00:00:00+00:00" />

</head>
  <body><nav>
  <img
    src="/img/nana-icons/shiba-computer-low.jpg"
    alt="A shiba using the computer"
    width="128"
    height="128"
  />
  <h1>~glorifiedgluer</h1>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/blogroll">Blogroll</a></li>
  </ul>
</nav>
<main>
  <h2>Custom JWT Authentication with F# and ASP.NET
    <small>
      <time>December 20, 2022</time>
    by ~glorifiedgluer


    </small>
  </h2><p>At my <code>$CURRENT_JOB</code> we are working on introducing a new back-end
service, and as usual, teams entirely composed of new-ish employees
face some hard time discovering all the small pieces required to make
the gears turn.</p>
<p>This time the challenge was to implement the authentication layer. It
is actually quite simple as it is just a <em>regular JWT</em> token, but the
devil&rsquo;s in the details:</p>
<ul>
<li>the token is on a custom header called `x-jwt-payload`</li>
<li>the token does not contain the <code>alg</code> attribute</li>
<li>the validation is done internally at the reverse proxy level</li>
</ul>
<p>OK, this doesn&rsquo;t sound <em>too</em> bad. However, it does take some tools
from our hands&hellip; ASP.NET has the <a href="https://devblogs.microsoft.com/dotnet/jwt-validation-and-authorization-in-asp-net-core/">UseJwtBearerAuthentication
middleware</a> that would take care of this workflow for us, but this
requires access to the <em>Authority</em><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> server which we don&rsquo;t have,
and also requires the <code>alg</code> attribute to decode the token.</p>
<p>Having said that, let&rsquo;s develop another middleware to take of our
authentication. I tried to reach the official documentation on how to
write a custom authentication scheme for ASP.NET but it was less than
useless. Then I tried to reach for blog posts, Stack Overflow
questions and open source projects, but they all seemed so convoluted
for such a small feature&hellip; When I was almost going to <em>brute force</em>
the solution out of my IDE through auto completion and debugging, <a href="https://stackoverflow.com/a/46568439">this
answer</a> appeared!</p>
<p>That&rsquo;s it! This is what I needed, a really concise example going
through each step of the authentication workflow. I wonder why
Microsoft doesn&rsquo;t have something like this on their docs. Or at least
not something easy to find there.</p>
<p>Alright, time to implement piece by piece of this code. Starting with
the Authentication scheme definition:</p>
<div class="highlight">
    <span class="highlight-type">fsharp</span>
    <pre><code class="language-fsharp hljs" data-lang="fsharp">  type CustomJwtAuthenticationOptions() =
      inherit AuthenticationSchemeOptions()

      member this.DefaultScheme = &#34;CustomJwtAuthentication&#34;
      member this.HeaderName = &#34;x-jwt-payload&#34;</code></pre>
</div>

<style>
    .highlight-type {
        content: "fsharp";
        position: absolute;
        opacity: 0.5;
    }
</style><p>The next missing part is the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1?view=aspnetcore-7.0">Authentication Handler</a>. For this, I&rsquo;ll
use the great <a href="https://demystifyfp.gitbook.io/fstoolkit-errorhandling">FsToolkit.ErrorHandling</a> package to help structure the
code, so do a <code>dotnet add package FsToolkit.ErrorHandling</code>.</p>
<div class="highlight">
    <span class="highlight-type">fsharp</span>
    <pre><code class="language-fsharp hljs" data-lang="fsharp">  type CustomJwtAuthenticationHandler
      (
          options: IOptionsMonitor&lt;CustomJwtAuthenticationOptions&gt;,
          logger: ILoggerFactory,
          encoder: UrlEncoder,
          clock: ISystemClock
      ) =
      inherit AuthenticationHandler&lt;CustomJwtAuthenticationOptions&gt;(options, logger, encoder, clock)

      override this.HandleAuthenticationAsync() =
          result {
              let! token = this.RetrieveTokenValue this.Options.HeaderName
              let! jwt = this.DecodeToken token

              let name =
                  let firstName =
                      jwt.Item(&#34;firstName&#34;) |&gt; string
                  let lastName =
                      jwt.Item(&#34;lastName&#34;) |&gt; string

                  $&#34;{firstName} {LastName}&#34;

              let claims =
                  [ Claim(ClaimTypes.NameIdentifier, jwt.Sub)
                    Claim(ClaimTypes.Name, name) ]

              let claimIdentity =
                  ClaimsIdentity(claims, this.Options.DefaultSchemeName)

              let ticket =
                  AuthenticationTicket(
                      ClaimsPrincipal(claimsIdentity),
                      AuthenticationProperties(),
                      this.Options.DefaultSchemeName
                  )

              return Task.FromResult(AuthenticateResult.Success(ticket))
          }
          |&gt; function
              | Ok value -&gt; value
              | Error e -&gt; Task.FromResult(AuthenticateResult.Fail(e))</code></pre>
</div>

<style>
    .highlight-type {
        content: "fsharp";
        position: absolute;
        opacity: 0.5;
    }
</style><p>And that&rsquo;s it! I now have the custom JWT authentication I needed for
my ASP.NET application. Of course, we are missing some helper methods
I used on the code. Let&rsquo;s take a look at them.</p>
<p>This function is used to extract the Base 64 token from the header.</p>
<div class="highlight">
    <span class="highlight-type">fsharp</span>
    <pre><code class="language-fsharp hljs" data-lang="fsharp">  member private this.RetrieveTokenValue name =
      let found, value =
          this.Request.Headers.TryGetValue(name)

      if not found then
          Error $&#34;Missing header &#39;{name}&#39;&#34;
      else
          value.ToString()
          |&gt; String.IsNullOrWhiteSpace
          |&gt; function
              | false -&gt; Ok value
              | true -&gt; Error $&#34;Missing header &#39;{name}&#39; value&#34;</code></pre>
</div>

<style>
    .highlight-type {
        content: "fsharp";
        position: absolute;
        opacity: 0.5;
    }
</style><p>Now the function responsible to decode the JWT token itself.</p>
<div class="highlight">
    <span class="highlight-type">fsharp</span>
    <pre><code class="language-fsharp hljs" data-lang="fsharp">  member private this.DecodeToken token =
      try
          let jwt =
              token
              |&gt; Convert.FromBase64String
              |&gt; Encoding.UTF8.GetString
              |&gt; Jwt.JwtPayload.Deserialize

          Ok jwt
      with
      | exn -&gt; Error $&#34;Error decoding token: {exn.Message}&#34;</code></pre>
</div>

<style>
    .highlight-type {
        content: "fsharp";
        position: absolute;
        opacity: 0.5;
    }
</style><p>OK, <strong>now</strong> we have everything needed to use our brand new
authentication scheme. How can we plug this together on our
application&rsquo;s startup? Considering that we&rsquo;re using <a href="https://saturnframework.org/">Saturn</a> to
configure it, it would look just like this:</p>
<div class="highlight">
    <span class="highlight-type">fsharp</span>
    <pre><code class="language-fsharp hljs" data-lang="fsharp">  let configureApp (app: IApplicationBuilder) =
      app.UseAuthentication()

  let configureServices (services: IServiceCollection) =
      services
          .AddAuthentication(
              CustomJwtAuthenticationOptions().DefaultScheme
          )
          .AddScheme&lt;CustomJwtAuthenticationOptions, CustomJwtAuthenticationHandler&gt;(
              CustomJwtAuthenticationOptions().DefaultScheme, (fun options -&gt; ())
          )
      |&gt; ignore

      services

  let main _ =
      let app =
          application {
              // ...
              app_config configureApp
              service_config configureServices
          }
          run app</code></pre>
</div>

<style>
    .highlight-type {
        content: "fsharp";
        position: absolute;
        opacity: 0.5;
    }
</style><div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>The address of the token-issuing authentication server. The JWT bearer authentication middleware will use this URI to find and retrieve the public key that can be used to validate the tokenâ€™s signature. It will also confirm that the iss parameter in the token matches this URI.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
<footer>
    <p><em>
        Have something to say about this? Feel free to send me an email at
        <a href="mailto:~glorifiedgluer/inbox@lists.sr.ht">my inbox</a>!
    </em></p>
</footer>

      </main>
    </main>
  </body>
</html>
