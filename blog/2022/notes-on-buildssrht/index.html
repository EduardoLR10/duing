<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  Notes on builds.sr.ht

    </title>
    
    <link rel="stylesheet" href="/css/main.min.2b661d17033c8e88dcb9551cb00d5235c93175108db6ef12ccc009cce52bdd00.css" /><meta property="og:title" content="Notes on builds.sr.ht" />
<meta property="og:description" content="I quite like builds.sr.ht and want to share some of the reasons." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://glorifiedgluer.com/blog/2022/notes-on-buildssrht/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-04-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-04-29T00:00:00+00:00" />

</head>
  <body><nav>
  <img
    src="/img/nana-icons/shiba-computer-low.jpg"
    alt="A shiba using the computer"
    width="128"
    height="128"
  />
  <h1>~glorifiedgluer</h1>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/blogroll">Blogroll</a></li>
  </ul>
</nav>
<main>
  <h2>Notes on builds.sr.ht
    <small>
      <time>April 29, 2022</time>
    by ~glorifiedgluer


    </small>
  </h2><p>For the past few months I&rsquo;ve been using <a href="https://sr.ht">sourcehut</a>&rsquo;s platform to work on software
an it has been quite an interesting experience. Nonetheless, one of the services
I really enjoy using is the their build service called <a href="https://builds.sr.ht">builds.sr.ht</a>.</p>
<blockquote>
<p>builds.sr.ht is a service on sr.ht that allows you to submit &ldquo;build manifests&rdquo;
for us to work on. &ndash; <a href="https://man.sr.ht/builds.sr.ht/">man.sr.ht</a></p>
</blockquote>
<p>The thing I don&rsquo;t like on <a href="https://github.com/features/actions">GitHub Actions</a> is that it is kind of <em>magical</em>. For
example, you don&rsquo;t actually know what it is doing when you define that an
<code>action</code> should only run when a specific path is modified. Not to even mention
their <a href="https://docs.github.com/pt/actions/creating-actions">custom actions</a> which usually takes a non-trivial amount of
TypeScript/JavaScript.</p>
<p>Contrary to this, <a href="https://builds.sr.ht">builds.sr.ht</a> is <em>really</em> explicit on its <a href="https://man.sr.ht/builds.sr.ht/manifest.md">build manifest</a>.
You&rsquo;re basically expected to write plain shell scripts for your builds.</p>
<h2 id="reducing-resource-usage">Reducing resource usage</h2>
<p>As I said previously, there&rsquo;s no special syntax to work on specific paths,
branches, pull requests and such. By default your task will run on every commit
you push. In order to reduce our CI usage we can restrain our tasks to run on
specific scenarios:</p>
<h3 id="on-path-change">On path change</h3>
<div class="highlight">
    <span class="highlight-type">sh</span>
    <pre><code class="language-sh hljs" data-lang="sh">if ! $(git diff --quiet HEAD HEAD^ -- &#34;&lt;your-path&gt;&#34;)
then
  # do something
fi</code></pre>
</div>

<style>
    .highlight-type {
        content: "sh";
        position: absolute;
        opacity: 0.5;
    }
</style><h3 id="on-branch-change">On branch change</h3>
<p>This tip was taken from <a href="https://todo.sr.ht/~sircmpwn/builds.sr.ht/170">issue #170</a>.</p>
<div class="highlight">
    <span class="highlight-type">yaml</span>
    <pre><code class="language-yaml hljs" data-lang="yaml">tasks:
- check-branch: |
   cd repo_name
   if [ &#34;$(git rev-parse your-branch)&#34; != &#34;$(git rev-parse HEAD)&#34; ]; then \
      complete-build; \
   fi</code></pre>
</div>

<style>
    .highlight-type {
        content: "yaml";
        position: absolute;
        opacity: 0.5;
    }
</style><h2 id="nixos-on-builds.sr.ht">NixOS on builds.sr.ht</h2>
<p>As I don&rsquo;t like to write shell scripts I use Nix and this is my favorite feature
of this service. builds.sr.ht supports <a href="https://nixos.org">NixOS</a> by default<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>. This means that
we can leverage Nix Flakes for truly declarative and reproducible builds there!
Let&rsquo;s consider a small example using <a href="https://go.dev">Go</a> to show you how easy it really is. A
small <code>flake.nix</code> containing the following content should suffice our needs:</p>
<div class="highlight">
    <span class="highlight-type">nix</span>
    <pre><code class="language-nix hljs" data-lang="nix">{
  inputs.nixpkgs.url = &#34;github:nixos/nixpkgs/nixos-unstable&#34;;

  outputs = { self, nixpkgs, ... }:
    let pkgs = import nixpkgs { system = &#34;x86_64-linux&#34;; };
    in
    {
      devShells.&#34;x86_64-linux&#34;.ci = with pkgs; mkShell {
        buildInputs = [ go golangci-lint ];
      };
    };
}</code></pre>
</div>

<style>
    .highlight-type {
        content: "nix";
        position: absolute;
        opacity: 0.5;
    }
</style><p>This definition is capable of giving us a shell containing Go and <a href="https://github.com/golangci/golangci-lint">golangci-lint</a>
on <code>$PATH</code>.</p>
<p>Now let&rsquo;s write the build manifest for our CI:</p>
<div class="highlight">
    <span class="highlight-type">yaml</span>
    <pre><code class="language-yaml hljs" data-lang="yaml">image: nixos/unstable
packages:
  - nixos.nixUnstable
environment:
  NIX_CONFIG: &#34;experimental-features = nix-command flakes&#34;
tasks:
  - lint: |
      cd source
      nix develop .#ci -c golangci-lint run
  - test: |
      cd source
      nix develop .#ci -c go test ./...
  - build: |
      cd source
      nix develop .#ci -c go build</code></pre>
</div>

<style>
    .highlight-type {
        content: "yaml";
        position: absolute;
        opacity: 0.5;
    }
</style><p>And that&rsquo;s it! We have our CI up and running with the guarantee of having our
tools being the same on every run. No sudden updates or unexpected behavior.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://nixos.org">https://nixos.org</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
<footer>
    <p><em>
        Have something to say about this? Feel free to send me an email at
        <a href="mailto:~glorifiedgluer/inbox@lists.sr.ht">my inbox</a>!
    </em></p>
</footer>

      </main>
    </main>
  </body>
</html>
