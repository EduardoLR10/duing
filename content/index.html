<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>~glorifiedgluer
    </title>
    
    <link rel="stylesheet" href="/css/main.min.2b661d17033c8e88dcb9551cb00d5235c93175108db6ef12ccc009cce52bdd00.css" /><meta property="og:title" content="~glorifiedgluer" />
<meta property="og:description" content="Pages  About  About me  I&#39;m Victor Freire, a student and software developer based in Guarulhos, Brazil, currently working at Divisions Maintenance Group as a software engineer writing F# and Nix.
 I&#39;ve taught myself coding, cloud computing and linux for years, out of passion. At the moment I&#39;m mostly interested in learning about highly scalable systems.
 My projects live at sourcehut and GitHub, you can also contact me via email." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://glorifiedgluer.com/content/" /><meta property="article:section" content="" />



</head>
  <body><nav>
  <img
    src="/img/nana-icons/shiba-computer-low.jpg"
    alt="A shiba using the computer"
    width="128"
    height="128"
  />
  <h1>~glorifiedgluer</h1>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/blogroll">Blogroll</a></li>
  </ul>
</nav>
<main>
  <h2>~glorifiedgluer</h2>
  
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
Pages
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
About
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<div id="outline-container-headline-3" class="outline-4">
<h4 id="headline-3">
About me
</h4>
<div id="outline-text-headline-3" class="outline-text-4">
<p>I&#39;m <strong>Victor Freire</strong>, a student and software developer based in <strong>Guarulhos,
Brazil</strong>, currently working at <a href="https://divisionsmg.com">Divisions Maintenance Group</a> as a
software engineer writing <a href="https://fsharp.org/">F#</a> and <a href="https://nixos.org">Nix</a>.</p>
<p>
I&#39;ve taught myself coding, cloud computing and linux for years, out of passion.
At the moment I&#39;m mostly interested in learning about highly scalable systems.</p>
<p>
My projects live at <a href="https://git.sr.ht/~glorifiedgluer">sourcehut</a> and <a href="https://github.com/ratsclub">GitHub</a>, you can also contact me via <a href="mailto:victor@freire.dev.br">email</a>.</p>
</div>
</div>
<div id="outline-container-headline-4" class="outline-4">
<h4 id="headline-4">
About this site
</h4>
<div id="outline-text-headline-4" class="outline-text-4">
<div id="outline-container-headline-5" class="outline-5">
<h5 id="headline-5">
Why?
</h5>
<div id="outline-text-headline-5" class="outline-text-5">
<p>This site was built for the only reason of sharing and documenting most of my
interests.</p>
</div>
</div>
<div id="outline-container-headline-6" class="outline-5">
<h5 id="headline-6">
How?
</h5>
<div id="outline-text-headline-6" class="outline-text-5">
<p>I intend to use as much <a href="https://www.gnu.org/philosophy/floss-and-foss.html">FOSS</a> as possible while producing its content.</p>
<div id="outline-container-headline-7" class="outline-6">
<h6 id="headline-7">
Software
</h6>
<div id="outline-text-headline-7" class="outline-text-6">
<ul>
<li>Icons made by my beloved nana</li>
<li>Generated using <a href="https://hugo.io">Hugo</a>, theme inspired by <a href="https://harelang.org">The Hare programming language website</a></li>
<li>Source code at <a href="https://git.sr.ht/~glorifiedgluer/glorifiedgluercom">sourcehut</a></li>
<li>Built with <a href="https://nixos.org">Nix</a> and <a href="https://builds.sr.ht/~glorifiedgluer/monorepo">builds.sr.ht</a></li>
<li>Hosted at <a href="https://srht.site/">pages.sr.ht</a></li>
</ul>
</div>
</div>
<div id="outline-container-headline-8" class="outline-6">
<h6 id="headline-8">
Hardware
</h6>
<div id="outline-text-headline-8" class="outline-text-6">
<ul>
<li>Pictures taken with a Fujifilm Instax Mini 90 or Nikon D3100</li>
<li>Analog pictures scanned with a Canon CanoScan LiDE 300</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-9" class="outline-3">
<h3 id="headline-9">
Blogroll
</h3>
<div id="outline-text-headline-9" class="outline-text-3">
<p>This page is a rendered version of my <a href="https://en.wikipedia.org/wiki/OPML">OPML</a> file.</p>
</div>
</div>
<div id="outline-container-headline-10" class="outline-3">
<h3 id="headline-10">
Home
</h3>
<div id="outline-text-headline-10" class="outline-text-3">
<p>This page is empty because I didn&#39;t find anything interesting to put here yet.</p>
<p>
Feel free to check out the navigation links above and enjoy the picture below.</p>
<img src="/img/capybara-gopher.png" alt="A capybara giving a ride to a gopher." title="Drawing by @psicochurroz."/>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-11" class="outline-2">
<h2 id="headline-11">
Blog&#xa0;&#xa0;&#xa0;<span class="tags"><span>@blog</span></span>
</h2>
<div id="outline-text-headline-11" class="outline-text-2">
<div id="outline-container-headline-12" class="outline-3">
<h3 id="headline-12">
Index
</h3>
<div id="outline-text-headline-12" class="outline-text-3">
<div class="description-block">
<p>Scattered thoughts, ideas and experiences.</p>
</div>
</div>
</div>
<div id="outline-container-headline-13" class="outline-3">
<h3 id="headline-13">
This will deteriorate quickly
</h3>
<div id="outline-text-headline-13" class="outline-text-3">
<div class="description-block">
<p>Thoughts about the current state of the web, content consuming and its longevity.</p>
</div>
<p>
In my teenager years I was a member of my school&#39;s student council. Part of our
job was to propose changes to our current infrastructure, organize study groups
and plan social projects. We were a bunch of youngsters without much experience
– or no experience at all – in the education field, therefore we resorted to
know from those who had it over the Internet. At the time there wasn&#39;t a lot of
content about it on social media, the majority was writing at Blogspot (now
<a href="https://blogger.com">Blogger</a>) or forums.</p>
<p>
Here comes <a href="https://pt.wikipedia.org/wiki/RSS">RSS</a>. Blogspot offered a <strong>RSS Feed</strong> by default so it was rather simple
to follow dozens of blogs. Every member of the council used a RSS reader they
liked the most and it worked great.</p>
<p>
Years passed and I found the list of blogs I used to read at that time. While
diving through the links I found out most of them didn&#39;t receive an update since
my highschool (or have just disappeared). However, they always had a link to the
author&#39;s social media (Twitter, Facebook or LinkedIn) and you could see those
profiles were being updated regularly. A lot of the educators continued to write
posts about their field of interest, but now on social media.</p>
<p>
In the meantime, I observed a pattern between profiles. They tended to reference
their old posts from the Blogger platform instead of publishing them again on
the new platform. Why so? You could see some of them tried to do that but
formatting was awkward as Facebook doesn&#39;t provide the same tools Blogger
offered and Twitter&#39;s posts are too short. So I feel they just couldn&#39;t retrieve
their posts and they were long gone from their hands.</p>
<p>
So how would an individual escape this madness? It&#39;s quite simple, a blog post
is nothing but static content. Text, images videos and audios. Use this in your
favor. Write text on known formats such as Markdown<sup class="footnote-reference"><a id="footnote-reference-1" href="#footnote-1">1</a></sup>, <a href="https://pt.wikipedia.org/wiki/ReStructuredText">ReStructuredText</a> or
even plain-text. Store all files in a <a href="https://git-scm.com">Git</a> repository, external hard drive,
Dropbox… whatever. Just stick to the simplest file formats and reliable
storage. Services like <a href="https://medium.com">Medium</a>, <a href="https://substack.com">Substack</a> and <a href="https://tumblr.com">Tumblr</a> can die and take all your
posts with them at any time.</p>
<p>
At the moment I&#39;m using <a href="https://neovim.io">Neovim</a> to edit my blog posts in Markdown and hosting
them in <a href="https://mataroa.blog">mataroa</a><sup class="footnote-reference"><a id="footnote-reference-2" href="#footnote-2">2</a></sup>. Alternatives are: <a href="https://gohugo.io">Hugo</a>, <a href="https://getzola.org">Zola</a> and more. All you need to setup a
web site is one of these programs, a bunch of Markdown files and a web server.
You&#39;ll also find a lot of places to host your content for free such as <a href="https://gitlab.com">GitLab</a>,
<a href="https://github.com">GitHub</a> or <a href="https://netlify.com">Netlify</a>.</p>
<p>
Although this approach brings some advantages, it has some shortcomings too. In
a static website you won&#39;t have a comments section without a third-party
service; basic tech knowledge is needed to know where to put files in your web
server provider of choice and if you want a custom domain such as this one
you&#39;ll have to do some configuration. A quick YouTube tutorial might be
sufficient to teach you how to do all of the above in minutes.</p>
</div>
</div>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
Burning out and finding out
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<div class="description-block">
<p>On being burnout for the first time.</p>
</div>
<img src="/img/2022-08-03-republica-station.jpg" alt="/img/2022-08-03-republica-station.jpg" title="São Paulo&#39;s República subway station. (2022-08-03)"/>
<p>
At the time of this writing I&#39;m burned out. I had no doubt it was a thing and
that it could happen to anyone. However, I couldn&#39;t see myself suffering from
this. At least not so soon.</p>
<blockquote>
<p>Burnout is caused when you repeatedly make large amounts of sacrifice and or
effort into high-risk problems that fail. It&#39;s the result of a negative
prediction error in the nucleus accumbens. You effectively condition your brain
to associate work with failure. — <a href="https://news.ycombinator.com/item?id=5630618">Source</a></p>
</blockquote>
<p>
I&#39;ve been pretty active for the past 4 to 5 years due to college, courses, work
and other activities. Yet all of this haven&#39;t bothered me in the slightest,
until now. I couldn&#39;t take control of basic chores, missed the point of meetings
after a few moments, had no will to leave the bed and many other things.
Moreover, It&#39;s a strange feeling with predefined steps:</p>
<ol>
<li>You know what you have to do;</li>
<li>You know it&#39;s within your capabilities;</li>
<li>You get excited to do the task;</li>
<li>Your body just <em>will not do it</em>.</li>
</ol>
<p>There you go, you now have the recipe to fight against yourself for a whole day.
This will be a excruciating battle until you hit the bed and repeat it the next
morning. That is, if you aren&#39;t already going to sleep late due to forcing
yourself to be productive throughout the day. Realizing I was battling my own
was really important to improve my situation. I started by cleaning my room,
then exercising, putting a alarm to tell me when to eat and so on. My next step
was to change my whole environment by looking after a new job.</p>
<p>
Currently I&#39;m not in position to take a sabbatical period of time to discover
new hobbies or a new career - and I don&#39;t want to, as I love my current
profession. So, what&#39;s left to ponder to change this situation, I may ask
myself? To be honest, I have no clue. While I&#39;m in the process to land a new job
I feel that this might be the response I needed to this feeling. New challenges,
new people, new technologies and new everything.</p>
</div>
</div>
<div id="outline-container-headline-15" class="outline-3">
<h3 id="headline-15">
write: broken pipe
</h3>
<div id="outline-text-headline-15" class="outline-text-3">
<div class="description-block">
<p>The adventure of figuring out the &#34;tcp: write: broken pipe&#34; error.</p>
</div>
<p>
<strong>tl;dr</strong>: <a href="https://docs.konghq.com/kubernetes-ingress-controller/">Kong Ingress Controller</a> was the culprit. Its timeout setting was
closing the connection before the file could be sent. /If you&#39;re facing this
issue in a long-lasting request, check your reverse proxy configuration, as it
may have a different configuration than your application./ ;-)</p>
<p>
At Grupo SBF we have an HTTP server written in <a href="https://go.dev/">Go</a> that queries <a href="https://cloud.google.com/bigquery">BigQuery</a> and
returns the result as a <strong>big</strong> csv file. However, after some time we sent a
request and instead of a file, we received this error message:</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">write tcp 10.0.0.1:8080-&gt;10.0.0.2:38302: write: broken pipe</span></span></code></pre></div>
</div>
<p>
Well, this is quite a surprise as we haven&#39;t seen this error message before…
After all, what does it even mean? A quick Google search returned this:</p>
<blockquote>
<p>A condition in programming (also known in POSIX as EPIPE error code and SIGPIPE
signal), when a process requests an output to pipe or socket, which was closed
by peer. – <a href="https://en.wikipedia.org/wiki/Broken_pipe">Wikipedia</a></p>
</blockquote>
<p>
Hmm, this <em>definitely</em> shed some light on the problem. Considering that the HTTP
server is provided by the powerful <a href="https://pkg.go.dev/net/http">net/http</a> package in Go&#39;s standard library, we
might have some obvious places to check out.</p>
<p>
Cloudflare has a <a href="https://blog.cloudflare.com/exposing-go-on-the-internet/">great article</a> talking about the default configuration on Go&#39;s
HTTP server and how to avoid making mistakes with them. We jumped straight to
the article&#39;s timeout section and checked if we didn&#39;t forget to configure them.</p>
<div class="src src-go">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ReadTimeout</span><span class="p">:</span>  <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span> <span class="c1">// 10 minutes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">WriteTimeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Addr</span><span class="p">:</span>         <span class="s">&#34;:8080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Handler</span><span class="p">:</span>      <span class="nx">r</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
For context, our application takes about 2 minutes to send a response so this
isn&#39;t a problem for us as we have 10 minutes until a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/504">504 server error</a> is
returned.</p>
<p>
To our amazement, sending the request to a local server returned no error
whatsoever. Comparing our local environment with production we also noticed that
our request was <em>dropped</em> at exactly 1 minute of execution in production.
Therefore it must be something between our client and server!</p>
<p>
Knowing that we deploy to a Kubernetes cluster with a <a href="https://docs.konghq.com/kubernetes-ingress-controller/">Kong Ingress Controller</a>
<sub>controlling</sub> taking care of our reverse proxy, we checked its documentation
and… Bingo! This is the root of our problem, as per the <a href="https://docs.konghq.com/gateway/1.1.x/reference/proxy/#3-proxying-and-upstream-timeouts">Kong Ingress
Controller Documentation</a> the default timeout is <code class="verbatim">60_000</code> milliseconds – in
other words, 1 minute!</p>
<div id="outline-container-replicating-the-behavior" class="outline-4">
<h4 id="replicating-the-behavior">
Replicating the behavior
</h4>
<div id="outline-text-replicating-the-behavior" class="outline-text-4">
<p>Before trying something on our servers, why don&#39;t we replicate this behavior
locally? For this purpose we can run a <code class="verbatim">nginx</code> container and a simple Go HTTP
server with a similar functionality of our service.</p>
<p>
The idea behind the test is to setup an endpoint that takes a lot of time
writing on the buffer while our reverse proxy has a timeout of only 2 seconds.</p>
<div id="outline-container-go-server-and-dockerfile" class="outline-5">
<h5 id="go-server-and-dockerfile">
Go server and Dockerfile
</h5>
<div id="outline-text-go-server-and-dockerfile" class="outline-text-5">
<div class="src src-go">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// creating a large data size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// that will take a long time to be written
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">size</span> <span class="o">:=</span> <span class="mi">900</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tpl</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;page&#34;</span><span class="p">).</span><span class="nf">Parse</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">tpl</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;error parsing template: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;error writing: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ReadTimeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">WriteTimeout</span><span class="p">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Addr</span><span class="p">:</span> <span class="s">&#34;:8080&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Handler</span><span class="p">:</span> <span class="nx">mux</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;server is running!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">srv</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
And then the Dockerfile:</p>
<div class="src src-dockerfile">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># server.Dockerfile</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> golang:alpine AS build</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apk --no-cache add gcc g++ make git<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /go/src/app</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> . .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> go mod init server<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> go mod tidy<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">GOOS</span><span class="o">=</span>linux go build -ldflags<span class="o">=</span><span class="s2">&#34;-s -w&#34;</span> -o ./bin/web-app ./server.go<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> alpine:3.13</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apk --no-cache add ca-certificates<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /usr/bin</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>build /go/src/app/bin /go/bin<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 8080</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> /go/bin/web-app --port <span class="m">8080</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-nginx-configuration-and-dockerfile" class="outline-5">
<h5 id="nginx-configuration-and-dockerfile">
nginx configuration and Dockerfile
</h5>
<div id="outline-text-nginx-configuration-and-dockerfile" class="outline-text-5">
<div class="src src-conf">
<pre tabindex="0"><code class="language-conf" data-lang="conf"># nginx.conf
events {
    worker_connections 1024;
}

http {
  server_tokens off;
  server {
    listen 80;

    location / {
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_set_header Host            $http_host;

      # timeout set to 2 seconds
      proxy_read_timeout 2s;
      proxy_connect_timeout 2s;
      proxy_send_timeout 2s;

      proxy_pass http://goservice:8080/;
    }
  }
}</code></pre>
</div>
<p>
And then the Dockerfile:</p>
<div class="src src-dockerfile">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># nginx.Dockerfile</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> nginx:latest</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 80</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> nginx.conf /etc/nginx/nginx.conf</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-docker-compose" class="outline-5">
<h5 id="docker-compose">
Docker Compose
</h5>
<div id="outline-text-docker-compose" class="outline-text-5">
<p>The last piece missing is a <a href="https://docs.docker.com/compose/">Docker
Compose</a> file to help us run these containers:</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># docker-compose.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.6&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">goservice</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;server.Dockerfile&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;8080&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nginx</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;nginx.Dockerfile&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;80:80&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;goservice&#34;</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-running-and-testing" class="outline-5">
<h5 id="running-and-testing">
Running and testing
</h5>
<div id="outline-text-running-and-testing" class="outline-text-5">
<p>After setting up our environment we can test it by running the commands below:</p>
<ul>
<li><code class="verbatim">docker-compose up --build</code> to run our containers</li>
<li><code class="verbatim">curl localhost</code> to make a request to our server</li>
</ul>
<p>Voilá! The error shows up confirming our theory!</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">goservice_1  | 2022/04/07 01:12:14 error writing: write tcp 172.18.0.2:8080-&gt;172.18.0.3:56768: write: broken pipe</span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-conclusion" class="outline-4">
<h4 id="conclusion">
Conclusion
</h4>
<div id="outline-text-conclusion" class="outline-text-4">
<p>This was a lot of fun to figure it! As noted by our tests the timeout
configuration of our cluster&#39;s reverse proxy was indeed the issue, overriding
the timeout settings with the snippet below solved the issue instantly!</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">configuration.konghq.com/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">KongIngress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;kong&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">kong-timeout-conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">proxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">connect_timeout</span><span class="p">:</span><span class="w"> </span><span class="m">10000000</span><span class="w"> </span><span class="c"># 10 minutes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">read_timeout</span><span class="p">:</span><span class="w"> </span><span class="m">10000000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">write_timeout</span><span class="p">:</span><span class="w"> </span><span class="m">10000000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">konghq.com/override</span><span class="p">:</span><span class="w"> </span><span class="l">kong-timeout-conf</span></span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-22" class="outline-3">
<h3 id="headline-22">
Notes on builds.sr.ht
</h3>
<div id="outline-text-headline-22" class="outline-text-3">
<div class="description-block">
<p>I quite like builds.sr.ht and want to share some of the reasons.</p>
</div>
<p>
For the past few months I&#39;ve been using <a href="https://sr.ht">sourcehut</a>&#39;s platform to work on software
an it has been quite an interesting experience. Nonetheless, one of the services
I really enjoy using is the their build service called <a href="https://builds.sr.ht">builds.sr.ht</a>.</p>
<blockquote>
<p>builds.sr.ht is a service on sr.ht that allows you to submit &#34;build manifests&#34;
for us to work on. – <a href="https://man.sr.ht/builds.sr.ht/">man.sr.ht</a></p>
</blockquote>
<p>
The thing I don&#39;t like on <a href="https://github.com/features/actions">GitHub Actions</a> is that it is kind of <em>magical</em>. For
example, you don&#39;t actually know what it is doing when you define that an
<code class="verbatim">action</code> should only run when a specific path is modified. Not to even mention
their <a href="https://docs.github.com/pt/actions/creating-actions">custom actions</a> which usually takes a non-trivial amount of
TypeScript/JavaScript.</p>
<p>
Contrary to this, <a href="https://builds.sr.ht">builds.sr.ht</a> is <em>really</em> explicit on its <a href="https://man.sr.ht/builds.sr.ht/manifest.md">build manifest</a>.
You&#39;re basically expected to write plain shell scripts for your builds.</p>
<div id="outline-container-reducing-resource-usage" class="outline-4">
<h4 id="reducing-resource-usage">
Reducing resource usage
</h4>
<div id="outline-text-reducing-resource-usage" class="outline-text-4">
<p>As I said previously, there&#39;s no special syntax to work on specific paths,
branches, pull requests and such. By default your task will run on every commit
you push. In order to reduce our CI usage we can restrain our tasks to run on
specific scenarios:</p>
<div id="outline-container-on-path-change" class="outline-5">
<h5 id="on-path-change">
On path change
</h5>
<div id="outline-text-on-path-change" class="outline-text-5">
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="k">if</span> ! <span class="k">$(</span>git diff --quiet HEAD HEAD^ -- <span class="s2">&#34;&lt;your-path&gt;&#34;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># do something</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-on-branch-change" class="outline-5">
<h5 id="on-branch-change">
On branch change
</h5>
<div id="outline-text-on-branch-change" class="outline-text-5">
<p>This tip was taken from <a href="https://todo.sr.ht/~sircmpwn/builds.sr.ht/170">issue #170</a>.</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">check-branch</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">   cd repo_name
</span></span></span><span class="line"><span class="cl"><span class="sd">   if [ &#34;$(git rev-parse your-branch)&#34; != &#34;$(git rev-parse HEAD)&#34; ]; then \
</span></span></span><span class="line"><span class="cl"><span class="sd">      complete-build; \
</span></span></span><span class="line"><span class="cl"><span class="sd">   fi</span><span class="w">   </span></span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-nixos-on-builds.sr.ht" class="outline-4">
<h4 id="nixos-on-builds.sr.ht">
NixOS on builds.sr.ht
</h4>
<div id="outline-text-nixos-on-builds.sr.ht" class="outline-text-4">
<p>As I don&#39;t like to write shell scripts I use Nix and this is my favorite feature
of this service. builds.sr.ht supports <a href="https://nixos.org">NixOS</a> by default<sup class="footnote-reference"><a id="footnote-reference-3" href="#footnote-3">3</a></sup>. This means that
we can leverage Nix Flakes for truly declarative and reproducible builds there!
Let&#39;s consider a small example using <a href="https://go.dev">Go</a> to show you how easy it really is. A
small <code class="verbatim">flake.nix</code> containing the following content should suffice our needs:</p>
<div class="src src-nix">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">inputs</span><span class="o">.</span><span class="n">nixpkgs</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&#34;github:nixos/nixpkgs/nixos-unstable&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">self</span><span class="o">,</span> <span class="n">nixpkgs</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="n">pkgs</span> <span class="o">=</span> <span class="kn">import</span> <span class="n">nixpkgs</span> <span class="p">{</span> <span class="n">system</span> <span class="o">=</span> <span class="s2">&#34;x86_64-linux&#34;</span><span class="p">;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">in</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">devShells</span><span class="o">.</span><span class="s2">&#34;x86_64-linux&#34;</span><span class="o">.</span><span class="n">ci</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="n">mkShell</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buildInputs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">go</span> <span class="n">golangci-lint</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</div>
<p>
This definition is capable of giving us a shell containing Go and <a href="https://github.com/golangci/golangci-lint">golangci-lint</a>
on <code class="verbatim">$PATH</code>.</p>
<p>
Now let&#39;s write the build manifest for our CI:</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nixos/unstable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">packages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">nixos.nixUnstable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">NIX_CONFIG</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;experimental-features = nix-command flakes&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">lint</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      cd source
</span></span></span><span class="line"><span class="cl"><span class="sd">      nix develop .#ci -c golangci-lint run</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      cd source
</span></span></span><span class="line"><span class="cl"><span class="sd">      nix develop .#ci -c go test ./...</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      cd source
</span></span></span><span class="line"><span class="cl"><span class="sd">      nix develop .#ci -c go build</span><span class="w">      </span></span></span></code></pre></div>
</div>
<p>
And that&#39;s it! We have our CI up and running with the guarantee of having our
tools being the same on every run. No sudden updates or unexpected behavior.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-27" class="outline-3">
<h3 id="headline-27">
Running a Raspberry Pi 4 with NixOS
</h3>
<div id="outline-text-headline-27" class="outline-text-3">
<div class="description-block">
<p>Configuring and running NixOS on a Raspberry Pi 4.</p>
</div>
<p>
For quite some time I&#39;ve been wanting to run a small homelab with <a href="https://nixos.org">NixOS</a>. I don&#39;t
host much services myself, however I feel that I can have a lot of fun (and
learn <em>a bit</em>) by maintaining my own server. All the services I run on the
Cloud™ (Matrix Dendrite and a Nix Binary Cache) could be running on a Raspberry
Pi inside my drawer. So that be it!</p>
<figure>
<img src="/img/raspberry-argon.jpg" alt="/img/raspberry-argon.jpg" title="/img/raspberry-argon.jpg" /><figcaption>
A picture of Raspberry Pi inside an Argon One case and a Keychron K2V2 behind
</figcaption>
</figure>
<div id="outline-container-setup" class="outline-4">
<h4 id="setup">
Setup
</h4>
<div id="outline-text-setup" class="outline-text-4">
<p>At the time of writing my setup looks like this:</p>
<ul>
<li>Case Argon ONE M.2</li>
<li>KingSpec SSD M.2 SATA - 512GB</li>
<li>Random Flash Drive - 8GB (you can also use a SD Card)</li>
<li>Raspberry Pi 4 - 8GB</li>
</ul>
</div>
</div>
<div id="outline-container-flashing" class="outline-4">
<h4 id="flashing">
Flashing
</h4>
<div id="outline-text-flashing" class="outline-text-4">
<p>Download the NixOS <code class="verbatim">aarch64</code> image. Personally I went with the <a href="https://hydra.nixos.org/job/nixos/trunk-combined/nixos.sd_image_new_kernel.aarch64-linux">unstable branch</a>
as I like to live dangerously but you can choose <a href="https://nixos.wiki/wiki/NixOS_on_ARM#SD_card_images_.28SBCs_and_similar_platforms.29">other versions</a> if you want to.
After that you just need to <code class="verbatim">dd</code> it to your flash drive and boot it:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ sudo dd <span class="k">if</span><span class="o">=</span>nixos.img <span class="nv">of</span><span class="o">=</span>/dev/sdX <span class="nv">bs</span><span class="o">=</span><span class="m">4096</span> <span class="nv">conv</span><span class="o">=</span>fsync <span class="nv">status</span><span class="o">=</span>progress</span></span></code></pre></div>
</div>
<p>
<strong>Notes</strong>:</p>
<ul>
<li>Don&#39;t forget to extract the image before flashing it.</li>
<li>If using the Argon One M.2 case, don&#39;t boot the USB Drive with your SSD connected. Otherwise your raspberry will try to boot from the SSD and not your Flash Drive/SD Card.</li>
</ul>
</div>
</div>
<div id="outline-container-formatting" class="outline-4">
<h4 id="formatting">
Formatting
</h4>
<div id="outline-text-formatting" class="outline-text-4">
<p>You can actually follow the <a href="https://nixos.org/manual/nixos/stable">NixOS Manual</a> to partition your hard drive. However
I&#39;ve written a script to help me do this:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># replace /dev/sda with your SSD</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">FMT_DISK</span><span class="o">=</span>/dev/sda
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">wipefs -a <span class="nv">$FMT_DISK</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">DISK</span><span class="o">=</span>/dev/disk/by-id/ata*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">parted <span class="nv">$FMT_DISK</span> -- mklabel msdos
</span></span><span class="line"><span class="cl">parted <span class="nv">$FMT_DISK</span> -- mkpart primary fat32 0MiB 512MiB <span class="c1"># $DISK-part1 is /boot</span>
</span></span><span class="line"><span class="cl">parted <span class="nv">$FMT_DISK</span> -- mkpart primary 512MiB -4GiB <span class="c1"># $DISK-part2 is the ext4 partition</span>
</span></span><span class="line"><span class="cl">parted <span class="nv">$FMT_DISK</span> -- mkpart primary linux-swap -4GiB 100% <span class="c1"># Swap</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkfs.ext4 -L nixos <span class="nv">$DISK</span>-part2
</span></span><span class="line"><span class="cl">mount <span class="nv">$DISK</span>-part2 /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkfs.vfat -F32 <span class="nv">$DISK</span>-part1
</span></span><span class="line"><span class="cl">mkdir -p /mnt/boot
</span></span><span class="line"><span class="cl">mount <span class="nv">$DISK</span>-part1 /mnt/boot</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-nixos-configuration" class="outline-4">
<h4 id="nixos-configuration">
NixOS Configuration
</h4>
<div id="outline-text-nixos-configuration" class="outline-text-4">
<p>In order to boot correctly, you need to define some boot options<sup class="footnote-reference"><a id="footnote-reference-4" href="#footnote-4">4</a></sup>:</p>
<div class="src src-nix">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">boot</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">initrd</span><span class="o">.</span><span class="n">availableKernelModules</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;usbhid&#34;</span> <span class="s2">&#34;usb_storage&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">kernelPackages</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">linuxPackages_rpi4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">kernelParams</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;8250.nr_uarts=1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;cma=128M&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;console=tty1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;console=ttyAMA0,115200&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">loader</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">raspberryPi</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">version</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">grub</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">generic-extlinux-compatible</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">hardware</span><span class="o">.</span><span class="n">enableRedistributableFirmware</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-boot-firmware" class="outline-4">
<h4 id="boot-firmware">
Boot firmware
</h4>
<div id="outline-text-boot-firmware" class="outline-text-4">
<p>The installer disk has a partition containing the necessary firmwares to boot
(it was on <code class="verbatim">/dev/sda1/</code> for me). Just copy it to your boot partition.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">mkdir /firmware
</span></span><span class="line"><span class="cl">mount /dev/sda1 /firmware
</span></span><span class="line"><span class="cl">cp /firmware/* /mnt/boot</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-installing" class="outline-4">
<h4 id="installing">
Installing
</h4>
<div id="outline-text-installing" class="outline-text-4">
<div id="outline-container-with-channels" class="outline-5">
<h5 id="with-channels">
With Channels
</h5>
<div id="outline-text-with-channels" class="outline-text-5">
<p>The only step left is to install the system:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nixos-install --root /mnt</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-with-flakes" class="outline-5">
<h5 id="with-flakes">
With Flakes
</h5>
<div id="outline-text-with-flakes" class="outline-text-5">
<p>Another way to install it is to make use of Nix <a href="https://nixos.wiki/wiki/Flakes">Flakes</a>. This way we can ensure
that our build is completely reproducible and/or running the same software
version as the other machines.</p>
<p>
This is a rather simple process if you already have a repo configured with your
<a href="https://nixos.org">NixOS</a> configurations. First, I need a shell with <code class="verbatim">git</code> and a <a href="https://nixos.org">Nix</a> version that
supports the experimental <a href="https://nixos.wiki/wiki/Flakes">Flakes</a> commands.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nix-shell -p git nixUnstable</span></span></code></pre></div>
</div>
<p>
After that I just clone my repository, copy the <code class="verbatim">hardware-configuration.nix</code>
file over and install the system.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># clone the repository</span>
</span></span><span class="line"><span class="cl">git clone https://git.sr.ht/~glorifiedgluer/dotfiles
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> dotfiles
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># copy hardware-configuration.nix</span>
</span></span><span class="line"><span class="cl">cp /mnt/etc/nixos/hardware-configuration.nix hosts/rpi4/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># install the system</span>
</span></span><span class="line"><span class="cl">nixos-install --flake .#rpi4</span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-36" class="outline-3">
<h3 id="headline-36">
Starting a personal monorepo
</h3>
<div id="outline-text-headline-36" class="outline-text-3">
<div class="description-block">
<p>Starting my journey with a personal monorepo managed by Nix.</p>
</div>
<p>
I&#39;ve been using <a href="https://nixos.org">Nix</a> as my package manager for 4 years now and it has been the
best <em>computer-related</em> decision I have ever made and fortunately, for the past
few years its ecosystem has been growing a lot<sup class="footnote-reference"><a id="footnote-reference-5" href="#footnote-5">5</a></sup> <sup class="footnote-reference"><a id="footnote-reference-6" href="#footnote-6">6</a></sup> <sup class="footnote-reference"><a id="footnote-reference-7" href="#footnote-7">7</a></sup>. Some of this
movement is due to the advent o <a href="https://nixos.wiki/wiki/Flakes">Flakes</a> that makes it <em>way</em> easier to share
reproducible outputs than the previous Nix solution of channels.</p>
<p>
Considering that I can use Nix:</p>
<ul>
<li>to share build artifacts (binaries, Nix modules and such);</li>
<li>to manage my dependencies;</li>
<li>as a build system.</li>
</ul>
<p>I thought to myself: &#34;Why not build a personal monorepo&#34;? I mean, this might
sound like a weird conclusion to take from all of this but I can explain! I
swear!</p>
<div id="outline-container-rationale" class="outline-4">
<h4 id="rationale">
Rationale
</h4>
<div id="outline-text-rationale" class="outline-text-4">
<p>Sometimes I just get bored setting up a new project. Create a new repository,
setup the dependencies, write a CI manifest… it&#39;s too tiresome! I won&#39;t even
mention the pain in the ass that is to write multiple projects on the multiple
machines. The clone, fetch, pull and push dance is just too much when I could be
coding already.</p>
<p>
Most of my personal projects are written in <a href="https://go.dev">Go</a>, a really boring language that
takes its time to include new features and release new versions. This means that
an update won&#39;t break them and that I can take advantage of a way to share the
same compiler and tooling version through my projects.</p>
<p>
If you&#39;re a Nix user, a single command would show you all the outputs available
for use: <code class="verbatim">nix flake show sourcehut:~glorifiedgluer/monorepo</code>. This also means
that you can import this repo as an input on your <code class="verbatim">flake.nix</code> file and use any
of my projects as you please.</p>
<p>
The CI can be simplified to a simple shell conditional:</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">someproject</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">      cd monorepo
</span></span></span><span class="line"><span class="cl"><span class="sd">      if ! $(git diff --quiet HEAD HEAD^ -- &#34;someproject&#34;)
</span></span></span><span class="line"><span class="cl"><span class="sd">      then
</span></span></span><span class="line"><span class="cl"><span class="sd">        # do something if the project got an update
</span></span></span><span class="line"><span class="cl"><span class="sd">      fi</span><span class="w">      </span></span></span></code></pre></div>
</div>
<p>
Nonetheless, the best reason to try this is out is to have some fun and explore
new challenges with version control and build systems! ;-)</p>
</div>
</div>
<div id="outline-container-expectation" class="outline-4">
<h4 id="expectation">
Expectation
</h4>
<div id="outline-text-expectation" class="outline-text-4">
<p>I mean… none? lol. Being serious now, I don&#39;t expect my projects to become
something used by hundreds or thousands of users as most of them are done out of
passion/need. So the rationale above is composed of things that personally took
out part of the joy of bulding out something and seeing it run.</p>
<p>
Is this going to work? I have no idea as I don&#39;t have much experience with
monorepos. I&#39;m not really sure if this is going to scale or bore me in other
ways. The only certainty I have is that I&#39;m having fun doing it <em>right now</em>!</p>
<p>
You can see the repository on the links below:</p>
<ul>
<li><a href="https://github.com/ratsclub/monorepo">GitHub</a></li>
<li><a href="https://git.sr.ht/~glorifiedgluer/monorepo/">sourcehut</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-39" class="outline-3">
<h3 id="headline-39">
Git mirroring, systemd and NixOS
</h3>
<div id="outline-text-headline-39" class="outline-text-3">
<div class="description-block">
<p>Configuring a Git mirror with systemd services and timers on NixOS.</p>
</div>
<p>
For the past few years I have been collecting contributions to multiple projects
on multiple platforms such as GitHub, GitLab, self-hosted Gitea instances and so
on. It&#39;s rather boring to go to a website and see the source code there… Then
I thought to myself: &#34;Why not write about a made up need I don&#39;t have just to
learn something new?&#34;.</p>
<p>
So, the idea here was to mirror those repositories into my <a href="https://sourcehut.org">sourcehut</a> account
(although this should work for any remote repository). For this we will use a
<a href="https://nixos.org">NixOS</a> system and <a href="https://www.freedesktop.org/software/systemd/man/systemd.timer.html">systemd timers</a>. The idea is dead simple, we clone the
repositories and push them to our desired remote.</p>
<div id="outline-container-configuring-the-repository" class="outline-4">
<h4 id="configuring-the-repository">
Configuring the repository
</h4>
<div id="outline-text-configuring-the-repository" class="outline-text-4">
<p>This step is pretty easy and can be done in two steps:</p>
<ol>
<li>Clone the repository</li>
</ol>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ git clone --mirror https://git.com/repo</span></span></code></pre></div>
</div>
<ol>
<li>Configure the remote as to ensure that we will only push to the
desired remote.</li>
</ol>
<div class="src src-sh">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ <span class="nb">cd</span> repo
</span></span><span class="line"><span class="cl">$ git remote set-url --push origin https://remote.com/repo-mirror</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-systemd-to-the-rescue" class="outline-4">
<h4 id="systemd-to-the-rescue">
systemd to the rescue
</h4>
<div id="outline-text-systemd-to-the-rescue" class="outline-text-4">
<p>We have our repository but we are still missing an important step that is to
keep pushing new changes to our mirror.</p>
<p>
<a href="https://nixos.org">NixOS</a> has a pretty good declarative way of declaring systemd services and timers
that we can take advantage of here. The idea is to have a script being ran in
our diretory through a systemd <em>service</em> that will be invoked by a systemd
<em>timer</em> hourly.</p>
<div id="outline-container-the-script" class="outline-5">
<h5 id="the-script">
The script
</h5>
<div id="outline-text-the-script" class="outline-text-5">
<p>There&#39;s nothing novel here. This script will iterate over the directories inside
the <code class="verbatim">WorkingDirectory</code>, fetch updates and then push it to our mirror.</p>
<div class="src src-nix">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="k">let</span>
</span></span><span class="line"><span class="cl">  <span class="n">gitmirrorScript</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">writeShellScriptBin</span> <span class="s2">&#34;gitmirror&#34;</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    for d in */ ; do
</span></span></span><span class="line"><span class="cl"><span class="s1">      git -C &#34;$d&#34; fetch -p origin
</span></span></span><span class="line"><span class="cl"><span class="s1">      git -C &#34;$d&#34; push --mirror
</span></span></span><span class="line"><span class="cl"><span class="s1">    done
</span></span></span><span class="line"><span class="cl"><span class="s1">  &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">in</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-the-service-and-timer" class="outline-5">
<h5 id="the-service-and-timer">
The service and timer
</h5>
<div id="outline-text-the-service-and-timer" class="outline-text-5">
<p>The service is rather simple too, we pass our repository&#39;s directory through the
<code class="verbatim">WorkingDirectory</code> value and set the <code class="verbatim">gitmirror</code> service as the unit to be
invoked by our timer. Note, however, that we added <code class="verbatim">git</code> <em>and</em> <code class="verbatim">openssh</code> to the
path. Your root user should be able to authenticate on boths repos with its ssh
key.</p>
<div class="src src-nix">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">systemd</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">gitmirror</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span> <span class="o">=</span> <span class="s2">&#34;Git mirror service&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">after</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;network.target&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span> <span class="n">git</span> <span class="n">openssh</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">serviceConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Type</span><span class="o">=</span><span class="s2">&#34;oneshot&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">WorkingDirectory</span> <span class="o">=</span> <span class="s2">&#34;/home/glorifiedgluer/repo&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExecStart</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="n">gitmirrorScript</span><span class="si">}</span><span class="s2">/bin/gitmirror&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">wantedBy</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;multi-user.target&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">systemd</span><span class="o">.</span><span class="n">timers</span><span class="o">.</span><span class="n">gitmirror</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span> <span class="o">=</span> <span class="s2">&#34;Git mirror timer&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">timerConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">OnCalendar</span> <span class="o">=</span> <span class="s2">&#34;hourly&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">Unit</span> <span class="o">=</span> <span class="s2">&#34;gitmirror.service&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">wantedBy</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&#34;timers.target&#34;</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-44" class="outline-3">
<h3 id="headline-44">
Moving this website to a single Org Mode file
</h3>
<div id="outline-text-headline-44" class="outline-text-3">
<div class="description-block">
<p>This website is now contained in a single Org Mode file.</p>
</div>
<p>
I have always loved <a href="https://www.gnu.org/software/emacs/">GNU Emacs</a> and its integrated computing environment. It has
been even better after I started using <a href="https://github.com/doomemacs/doomemacs">Doom Emacs</a><sup class="footnote-reference"><a id="footnote-reference-8" href="#footnote-8">8</a></sup>, it basically took care of
things I was unable to do properly: make it fast and semantically coherent.
Either for the lack of time or technical knowledge.</p>
<p>
As most GNU Emacs users, I love <a href="https://orgmode.org/">Org Mode</a> and I love to write for this blog. So
why not join these two things together? <a href="https://ox-hugo.scripter.co/">ox-hugo</a> let&#39;s me write a <em>org</em> file and
turn it into multiple <em>hugo-compatible</em> markdown files. This is quite a feature
for me as I like to keep all my <em>stuff</em> into one place<sup class="footnote-reference"><a id="footnote-reference-9" href="#footnote-9">9</a></sup>.</p>
<p>
It would be pretty cool to have a place to share small trips with pictures and
some comments. Thinking about it a bit more, it might work like some sort of
microblog but… different? I should start doing it and stop ovethinking. It
would be pretty cool to read a huge file with years of history written on it!</p>
<p>
Oh, and you can see the file I&#39;m talking about right here:
<a href="https://git.sr.ht/~glorifiedgluer/monorepo/blob/main/glorifiedgluercom/content/content.org">sourcehut:~glorifiedgluer/monorepo/glorifiedgluercom/content/content.org</a>.</p>
</div>
</div>
<div id="outline-container-headline-45" class="outline-3">
<h3 id="headline-45">
ErgoJourney - Choosing a new keyboard layout
</h3>
<div id="outline-text-headline-45" class="outline-text-3">
<div class="description-block">
<p>The beginning of my journey for an ergonomic setup. Starting with a new keyboard layout.</p>
</div>
<p>
After multiple injuries to my right wrist due to a multitude of activities
(sports, bad typing<sup class="footnote-reference"><a id="footnote-reference-10" href="#footnote-10">10</a></sup> and an <em>act of god</em>) I decided to change my keyboard layout
to one that could possibly demand less work off of my hands.</p>
<p>
First let&#39;s go through a small history of keyboards I&#39;ve previously used.
Unfortunately I don&#39;t actually have pictures of them as I don&#39;t have the habit
to take pictures of things (which I should reconsider!). Briefly, the complete
list is the following:</p>
<ol>
<li>IBM Model M</li>
<li>ThinkPad X230</li>
<li>HyperX Alloy FPS Pro (Cherry MX Blue)</li>
<li>Keychron K2V2 (Cherry MX Red)</li>
<li>Corne V3 (failed attempt, the PCB wasn&#39;t delivered)</li>
<li>SZA Moonlander Mark I</li>
</ol>
<div id="outline-container-headline-46" class="outline-4">
<h4 id="headline-46">
Previously used keyboards
</h4>
<div id="outline-text-headline-46" class="outline-text-4">
<p>
Let&#39;s talk about the keyboards I have owned for the past decade.
There was a place near (São Paulo is huge but everything is close if you can
walk to the subway) my work called <em>Santa Efigênia</em>. At the time, this was the
biggest place to go look after tech gadgets here in São Paulo.</p>
<p>
As all places like this, there were a lot of second-hand shops. Places that
bought boxes after boxes of old corporate hardware. And this is how I got my
hands on an <strong><a href="https://en.wikipedia.org/wiki/Model_M_keyboard">IBM Model M</a></strong>! I&#39;m going to be honest with you, I didn&#39;t know it was
a <em>rare</em> keyboard nor that it was an icon of some sort. I just liked the design
and bought it for a cheap price as it was the cooler PS/2 keyboard I could find
there.</p>
<p>
After selling my <em>Model M</em> way cheaper than I should (😭) I got a <strong><a href="https://en.wikipedia.org/wiki/ThinkPad_X_series#X230">ThinkPad
X230</a></strong> that I used for about 10 years or so. I really liked the feeling of the
keyboard and even tried to mod it to use the X220 but I have the unpopular
opinion that the X230 has the best keyboard.</p>
<p>
While using my <em>X230</em> I finally discovered what a mechanical keyboard is <del>and
instantly regretted my decisions on the <em>Model M</em></del> and got a <strong><a href="https://row.hyperx.com/pt-br/products/hyperx-alloy-fps-pro-mechanical-gaming-keyboard">HyperX Alloy FPS
Pro</a></strong> with <em>Cherry MX Blue</em> switches for a steal. For the price I paid it was an
actually OK keyboard, however the full price was not worth it in my opinion. I
found the switch too heavy for hours of typing and the sound was just… weird.
I can&#39;t explain but for me it was not that pleasant type on it. Anyway, I ended
up selling it too.<sup class="footnote-reference"><a id="footnote-reference-11" href="#footnote-11">11</a></sup></p>
</div>
</div>
<div id="outline-container-headline-47" class="outline-4">
<h4 id="headline-47">
Current keyboard
</h4>
<div id="outline-text-headline-47" class="outline-text-4">
<p>
My current keyboard is the <a href="https://www.keychron.com/products/keychron-k2-hot-swappable-wireless-mechanical-keyboard">Keychron K2 Version 2</a>. It&#39;s Wireless, Hot-swappable
(meaning that I can <em>swap</em> the switches), Compact layout (84 keys<sup class="footnote-reference"><a id="footnote-reference-12" href="#footnote-12">12</a></sup>) and
Gateron G Red Switch (pre-lubed).</p>
<p>
Some things I learned with this keyboard is that I more fond of linear switches
than clicky/tactile ones. The thing that bothered me the most is that the
keycaps accumulated a lot of grease and started to get too shiny<sup class="footnote-reference"><a id="footnote-reference-13" href="#footnote-13">13</a></sup>.</p>
</div>
</div>
<div id="outline-container-headline-48" class="outline-4">
<h4 id="headline-48">
Future Keyboards
</h4>
<div id="outline-text-headline-48" class="outline-text-4">
<div id="outline-container-headline-49" class="outline-5">
<h5 id="headline-49">
Corne V3
</h5>
<div id="outline-text-headline-49" class="outline-text-5">
<p>
One of the first things you discover when you start to look after ergonomic
keyboards is that you can build one yourself. There is a multitude of
communities, projects and contents over the internet.</p>
<p>
I really liked some models:</p>
<ol>
<li><a href="https://github.com/davidphilipbarr/Sweep">Sweep</a> is a <em>34 keys</em> split keyboard. I wanted a bit more keys, so I
discarded this one.</li>
<li><a href="https://github.com/diepala/cantor/">Cantor</a> is a <em>42 keys</em> split keyboard. The problem with this one is that I
couldn&#39;t find the required low-profile switches for cheap, so I discarded
this option. However, it was my favorite design!</li>
<li><a href="https://github.com/foostan/crkbd">Corne</a> is a <em>36 keys</em> split keyboard. This is probably the most famous split
keyboard. I chose it because it was basically the cheapest option for me and
also had more keys than Sweep.</li>
</ol>
<p>Although I bought everything needed to start soldering the Corne together, my
country&#39;s post office probably lost my PCB during delivery. So I don&#39;t have much
to say about, if they happen to deliver it I might write about my experience
soldering it or just straight out buy the <a href="https://keyhive.xyz/shop/corne-v3">complete kit from KeyHive</a>.</p>
</div>
</div>
<div id="outline-container-headline-50" class="outline-5">
<h5 id="headline-50">
SZA Moonlader Mark I
</h5>
<div id="outline-text-headline-50" class="outline-text-5">
<p>
At the moment I&#39;m waiting for my <a href="https://www.zsa.io/moonlander/">Moonlander SZA Mark I</a> to arrive. I didn&#39;t do
much research on the keyboard as I wasn&#39;t intending on buying one (too expensive
here) and instead I got one as a gift! Given this, I thought it would be cool to wait
for a cool unboxing experience to a novel technology for me.</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-51" class="outline-4">
<h4 id="headline-51">
Drinking the Colemak Kool-Aid
</h4>
<div id="outline-text-headline-51" class="outline-text-4">
<p>
Considering this huge introduction, my conclusion was that I should probably
take advantage of this new keyboard form I&#39;m getting and learn a new keyboard
layout. This might give me some benefits upon my wrist injuries and make typing
less painful.</p>
<p>
I was between <a href="https://en.wikipedia.org/wiki/Dvorak_keyboard_layout">Dvorak</a> and <a href="https://colemak.com/">Colemak</a> but the thing is, all the discussions around
these layouts seemed to be mostly about personal preferences so I decided to
pick one with the most sensible technique: <strong>the coin flip</strong> and the coin told me
to go with Colemak.</p>
<p>
Through my small research I found out that Colemak ships by default on most
Linux distros and it works very good with other languages (Brazilian Portuguese
🇧🇷).</p>
<p>
I guess that the only thing left is to practice typing on it now!</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-52" class="outline-3">
<h3 id="headline-52">
Implementing Correlation IDs in F# with Giraffe and Serilog
</h3>
<div id="outline-text-headline-52" class="outline-text-3">
<div class="description-block">
<p>Adding a unique ID to each ASP.NET request/response in F# with Serilog.</p>
</div>
<img src="/img/2022-08-03-penha-station.jpg" alt="/img/2022-08-03-penha-station.jpg" title="São Paulo&#39;s Penha subway station. (2022-08-03)"/>
<p>
I spent a stupid amount of time trying to setup an <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-6.0">ASP.NET Middleware</a> to handle
correlation IDs on requests. I must confess that I just got my first .NET <strong>and</strong>
F#<sup class="footnote-reference"><a id="footnote-reference-14" href="#footnote-14">14</a></sup> job, therefore most of the time spent was just getting used to the
whole ecosystem. However during my trial and error I saw a bunch of blog posts
showing me how to do this in different manners and a lot discussions about the
correct order to implement things.</p>
<blockquote>
<p>A correlation ID is a unique ID that is assigned to every transaction. So, when
a transaction becomes distributed across multiple services, we can follow that
transaction across different services using the logging information. — Gaurav
Kumar Aroraa, Lalit Kale and Kanwar Manish</p>
</blockquote>
<p>
This was written with the following versions:</p>
<ul>
<li>.NET SDK 6.0.400</li>
<li>Giraffe 6.0.0 - <code class="verbatim">dotnet add package Giraffe -v 6.0.0</code></li>
<li>Serilog 2.11.0 - <code class="verbatim">dotnet add package Serilog -v 2.11.0</code></li>
<li>Serilog.AspNetCore - <code class="verbatim">dotnet add package Serilog.AspNetCore -v 6.0.1</code></li>
</ul>
<div id="outline-container-headline-53" class="outline-4">
<h4 id="headline-53">
Importing the needed modules
</h4>
<div id="outline-text-headline-53" class="outline-text-4">
<p>Let&#39;s get started by importing all the needed packages:</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">System</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Builder</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Http</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.Extensions.Hosting</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Microsoft.AspNetCore.Hosting</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Giraffe</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Serilog</span>
</span></span><span class="line"><span class="cl"><span class="k">open</span> <span class="nn">Serilog.Context</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-54" class="outline-4">
<h4 id="headline-54">
Starting the web host
</h4>
<div id="outline-text-headline-54" class="outline-text-4">
<p>Differently from <a href="https://saturnframework.org/">Saturn</a>, Giraffe doesn&#39;t have a <a href="https://docs.microsoft.com/en-us/dotnet/fsharp/language-reference/computation-expressions">computation expression</a> to
configure our web host. With that in mind, the code below must do the job.</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Entry</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">open</span> <span class="nn">Configuration</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nn">Log</span><span class="p">.</span><span class="n">Logger</span> <span class="o">&lt;-</span>
</span></span><span class="line"><span class="cl">        <span class="n">LoggerConfiguration</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">Enrich</span><span class="o">.</span><span class="n">FromLogContext</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">WriteTo</span><span class="o">.</span><span class="n">Console</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">outputTemplate</span> <span class="o">=</span> <span class="s">&#34;[{Timestamp:HH:mm:ss} {CorrelationId} {Level:u3}] {Message:lj}{NewLine}{Exception}&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">CreateLogger</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">[&lt;</span><span class="n">EntryPoint</span><span class="o">&gt;]</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">main</span> <span class="n">args</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nn">Host</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">CreateDefaultBuilder</span><span class="o">(</span><span class="n">args</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">ConfigureWebHost</span><span class="o">(</span><span class="n">configureWebHost</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">UseSerilog</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">Build</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">Run</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">0</span></span></span></code></pre></div>
</div>
<p>
The key parts of the code are:</p>
<ul>
<li><code class="verbatim">.Enrich.FromLogContext()</code></li>
<li>The <code class="verbatim">outputTemplate</code> containing the <code class="verbatim">CorrelationId</code> property</li>
</ul>
<p>We will define the <code class="verbatim">configureWebHost</code> in another module called <code class="verbatim">Configuration</code>.
This same module contains other helper functions related to the Host
configuration.</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Configuration</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">configureApp</span> <span class="o">(</span><span class="n">builder</span><span class="o">:</span> <span class="n">IApplicationBuilder</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">UseMiddleware</span><span class="o">&lt;</span><span class="nn">Middleware</span><span class="p">.</span><span class="n">CorrelationId</span><span class="o">&gt;</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">UseGiraffe</span> <span class="nn">Endpoint</span><span class="p">.</span><span class="n">router</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">configureServices</span> <span class="o">(</span><span class="n">services</span><span class="o">:</span> <span class="n">IServiceCollection</span><span class="o">)</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">AddGiraffe</span><span class="bp">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">configureWebHost</span> <span class="o">(</span><span class="n">builder</span><span class="o">:</span> <span class="n">IWebHostBuilder</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="n">builder</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">Configure</span><span class="o">(</span><span class="n">configureApp</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">ConfigureServices</span><span class="o">(</span><span class="n">configureServices</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">UseKestrel</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">UseUrls</span><span class="o">([|</span> <span class="s">&#34;http://0.0.0.0:8000&#34;</span> <span class="o">|])</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="n">UseWebRoot</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">|&gt;</span> <span class="n">ignore</span></span></span></code></pre></div>
</div>
<p>
Here we can see a <code class="verbatim">Middleware.CorrelationId</code> being implemented as an ASP.NET
Middleware.</p>
</div>
</div>
<div id="outline-container-headline-55" class="outline-4">
<h4 id="headline-55">
Implementing the middleware
</h4>
<div id="outline-text-headline-55" class="outline-text-4">
<p>The mechanism of this middleware is quite simple. One of the possible ways to
implement a correlation ID propagation on web APIs is to pass a unique value as
request header. In our case, it will be passed around on a header key called
<code class="verbatim">X-Correlation-Id</code>.</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Middleware</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">type</span> <span class="nc">CorrelationId</span><span class="o">(</span><span class="n">next</span><span class="o">:</span> <span class="n">RequestDelegate</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">Invoke</span><span class="o">(</span><span class="n">context</span><span class="o">:</span> <span class="n">HttpContext</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">let</span> <span class="nv">headerName</span> <span class="o">=</span> <span class="s">&#34;X-Correlation-Id&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">let</span> <span class="nv">logPropertyName</span> <span class="o">=</span> <span class="s">&#34;CorrelationId&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">let</span> <span class="nv">success</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Headers</span><span class="o">.</span><span class="n">TryGetValue</span> <span class="n">headerName</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">let</span> <span class="nv">correlationId</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">success</span>
</span></span><span class="line"><span class="cl">                <span class="k">then</span> <span class="n">value</span><span class="o">.</span><span class="n">ToString</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span> <span class="nn">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="bp">()</span><span class="o">.</span><span class="n">ToString</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="o">.</span><span class="n">Response</span><span class="o">.</span><span class="n">Headers</span><span class="o">.</span><span class="n">Add</span><span class="o">(</span><span class="n">headerName</span><span class="o">,</span> <span class="n">correlationId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">using</span> <span class="o">(</span><span class="nn">LogContext</span><span class="p">.</span><span class="n">PushProperty</span><span class="o">(</span><span class="n">logPropertyName</span><span class="o">,</span> <span class="n">correlationId</span><span class="o">))</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="n">next</span><span class="o">.</span><span class="n">Invoke</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">)</span></span></span></code></pre></div>
</div>
<p>
The logic is the following:</p>
<ol>
<li>Check if there&#39;s a value on the <code class="verbatim">X-Correlation-Id</code> header key</li>
<li>If there&#39;s a value, we turn this into a string. Otherwise, we create a Guid as the correlation id.</li>
<li>Add the header to the response with the extracted correlation id</li>
</ol>
</div>
</div>
<div id="outline-container-headline-56" class="outline-4">
<h4 id="headline-56">
Testing with an actual request
</h4>
<div id="outline-text-headline-56" class="outline-text-4">
<p>For a testing purpose, let&#39;s create a <em>Hello, World!</em> endpoint with a simple
log.</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl"><span class="k">module</span> <span class="nn">Endpoint</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">HelloHandler</span><span class="o">:</span> <span class="n">HttpHandler</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">fun</span> <span class="o">(</span><span class="n">next</span><span class="o">:</span> <span class="n">HttpFunc</span><span class="o">)</span> <span class="o">(</span><span class="n">ctx</span><span class="o">:</span> <span class="n">HttpContext</span><span class="o">)</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nn">Log</span><span class="p">.</span><span class="n">Information</span> <span class="s">&#34;Helloing the world!&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">json</span> <span class="o">{|</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Hello, World!&#34;</span> <span class="o">|}</span> <span class="n">next</span> <span class="n">ctx</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">let</span> <span class="nv">router</span> <span class="o">=</span> <span class="n">route</span> <span class="s">&#34;/&#34;</span> <span class="o">&gt;=&gt;</span> <span class="n">HelloHandler</span></span></span></code></pre></div>
</div>
<p>
Doing a simple request through a web browser should return a basic <code class="verbatim">{ &#34;message&#34;:
&#34;Hello, World!&#34; }</code> json text and show a your console should show the correlation
id of our request.</p>
<pre class="example">
[20:34:49  INF] Application started. Press Ctrl+C to shut down.
[20:34:49  INF] Hosting environment: Production
[20:34:49  INF] Content root path: /home/user/foo/barr
[20:34:49  INF] Request starting HTTP/1.1 GET http://localhost:8000/ - -
[20:34:49 fe7b6dd7-eec4-4792-9fda-de814ef5dd14 INF] Helloing the world!
[20:34:50  INF] Request finished HTTP/1.1 GET http://localhost:8000/ - - - 200 27 application/json;+charset=utf-8 1126.8972ms
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-57" class="outline-3">
<h3 id="headline-57">
Building a Dell PowerEdge T410 NAS with NixOS and ZFS
</h3>
<div id="outline-text-headline-57" class="outline-text-3">
<div class="description-block">
<p>My journey into the sysadmin rabbithole with a personal NAS.</p>
</div>
<p>
For some time I&#39;ve been thinking about getting a NAS for personal usage.
However, most of the <em>prebuilt</em> solutions are too expensive here and they don&#39;t
even come with hard drives… I then decided to research a cheap way to build it
my own.</p>
<p>
One famous guide for home-built NAS is the <a href="https://forums.serverbuilds.net/t/guide-nas-killer-5-0/3072">NAS KILLER</a> series by <a href="https://old.reddit.com/user/JDM_WAAAT/">u/JDM_WAAAT</a>. I
tried to find most of the parts shown there but I always missed one as it was
either not available or couldn&#39;t be shipped here. This way my only choice was to
look at the prebuilt options they mention on the series. I saw a mention of some
models of Dell PowerEdges and decided to take a look at the local second-hand
market.</p>
<p>
There it was, a Dell PowerEdge T410 for R\$400 (equivalent of \$75) including
shipping. Such a steal considering that they go fora bout  R\$3.5k here! The
specs are the following:</p>
<table>
<tbody>
<tr>
<td>Host</td>
<td>Dell PowerEdge 410</td>
</tr>
<tr>
<td>CPU</td>
<td>Intel Xeon X5660 (12) @ 1.596GHz</td>
</tr>
<tr>
<td>GPU</td>
<td>Matrox Electronics Systems Ltd. PowerEdge T410</td>
</tr>
<tr>
<td>Memory</td>
<td>32GB DDR3 ECC 1600MHz</td>
</tr>
</tbody>
</table>
<p>
You can see the whole cost of this setup below:</p>
<table>
<thead>
<tr>
<th>Date (in days)</th>
<th>Item</th>
<th class="align-right">Price (R$)</th>
</tr>
</thead>
<tbody>
<tr>
<td><span class="timestamp">&lt;2022-09-07 Wed&gt;</span></td>
<td>Dell PowerEdge T410 <sup class="footnote-reference"><a id="footnote-reference-15" href="#footnote-15">15</a></sup></td>
<td class="align-right">400</td>
</tr>
<tr>
<td><span class="timestamp">&lt;2022-09-07 Wed&gt;</span></td>
<td><a href="https://pt.aliexpress.com/item/1005004253108255.html">Dell PERC H200</a> <sup class="footnote-reference"><a id="footnote-reference-16" href="#footnote-16">16</a></sup></td>
<td class="align-right">166.96</td>
</tr>
<tr>
<td><span class="timestamp">&lt;2022-09-09 Fri&gt;</span></td>
<td><a href="https://produto.mercadolivre.com.br/MLB-2199914105-hdd-dell-4tb-sas-6gbps-rpm-72k-35-st4000nm0023-pn-0drmyh-_JM">5x Seagate ST4000NM0023 4TB</a> <sup class="footnote-reference"><a id="footnote-reference-17" href="#footnote-17">17</a></sup></td>
<td class="align-right">4455</td>
</tr>
<tr>
<td><span class="timestamp">&lt;2022-10-20 Thu&gt;</span></td>
<td><a href="https://pt.aliexpress.com/item/32840300151.html">32GB 1600MHz RAM DDR3 ECC (16x2)</a></td>
<td class="align-right">161.51</td>
</tr>
</tbody>
<tbody>
<tr>
<td>43</td>
<td></td>
<td class="align-right">5183.47</td>
</tr>
</tbody>
</table>
<div id="outline-container-headline-58" class="outline-4">
<h4 id="headline-58">
Upgrading the PowerEdge RAID Controller (PERC)
</h4>
<div id="outline-text-headline-58" class="outline-text-4">
<p>
Unfortunately my server came with a <a href="https://www.dell.com/support/kbdoc/en-us/000131648/list-of-poweredge-raid-controller-perc-types-for-dell-emc-systems">Dell PERC 6/I</a> which only supports disks as
big as 2TB. Doing some research over the internet I found out that I had two
options of upgrades here: H200 or H700.</p>
<p>
As I&#39;m going to use ZFS as my filesystem, I went with H200 because I can just
use it in IT mode (as JBOD) making it possible to pass all the drives directly
to my ZFS pool without the hardware interfering much.</p>
<p>
Now something that I want to confess here… I was afraid to buy this server and
have to pay enterprise prices for hardware or even restrict my ability to
expand/replace the system. However, I learned that I can use my new H200 PERC on
a regular desktop<sup class="footnote-reference"><a id="footnote-reference-18" href="#footnote-18">18</a></sup> with some special cables you can buy for cheap so I
might even be able to build a smaller machine with the same amount of disks and
a more balanced power/comsuption ratio.</p>
</div>
</div>
<div id="outline-container-headline-59" class="outline-4">
<h4 id="headline-59">
Setting up SSH
</h4>
<div id="outline-text-headline-59" class="outline-text-4">
<p>
The first thing I do on the NixOS installation media is to change the <code>nixos</code>
user password to proceed the installation in another computer:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ passwd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># over the other computer</span>
</span></span><span class="line"><span class="cl">$ ssh nixos@&lt;ip&gt;</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-60" class="outline-4">
<h4 id="headline-60">
Configuring the disks
</h4>
<div id="outline-text-headline-60" class="outline-text-4">
<p>
Fortunately, using ZFS with NixOS is a breeze. It has a really good support and
I can even boot from a ZFS pool. Let&#39;s start by listing the disks and getting
their IDs:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>nixos@nixos:~<span class="o">]</span>$ ls -al /dev/disk/by-id/
</span></span><span class="line"><span class="cl">total <span class="m">0</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root root <span class="m">340</span> Nov  <span class="m">2</span> 15:12 .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">7</span> root root <span class="m">140</span> Nov  <span class="m">2</span> 14:54 ..
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root   <span class="m">9</span> Nov  <span class="m">2</span> 15:12 scsi-35000c500571d23bf -&gt; ../../sdb
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root   <span class="m">9</span> Nov  <span class="m">2</span> 15:12 scsi-35000c500964ac36f -&gt; ../../sdd
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root   <span class="m">9</span> Nov  <span class="m">2</span> 15:12 scsi-35000c500964b5e7b -&gt; ../../sdc
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root   <span class="m">9</span> Nov  <span class="m">2</span> 15:12 scsi-35000c500964b723b -&gt; ../../sdf
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root   <span class="m">9</span> Nov  <span class="m">2</span> 15:12 scsi-35000c500964bbbd3 -&gt; ../../sde</span></span></code></pre></div>
</div>
<p>
We should use the disks IDs on our ZFS pool, this will avoid some headaches in
the future as switching the HDs bays and ZFS losing tracks of which disk is
which. Ok, now that we have the IDs, let&#39;s wipe them to make sure we don&#39;t have
any filesystems on them already.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">DISK1</span><span class="o">=</span>/dev/disk/by-id/scsi-35000c500571d23bf
</span></span><span class="line"><span class="cl"><span class="nv">DISK2</span><span class="o">=</span>/dev/disk/by-id/scsi-35000c500964ac36f
</span></span><span class="line"><span class="cl"><span class="nv">DISK3</span><span class="o">=</span>/dev/disk/by-id/scsi-35000c500964b5e7b
</span></span><span class="line"><span class="cl"><span class="nv">DISK4</span><span class="o">=</span>/dev/disk/by-id/scsi-35000c500964b723b
</span></span><span class="line"><span class="cl"><span class="nv">DISK5</span><span class="o">=</span>/dev/disk/by-id/scsi-35000c500964bbbd3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo wipefs -af <span class="nv">$DISK1</span>
</span></span><span class="line"><span class="cl">sudo wipefs -af <span class="nv">$DISK2</span>
</span></span><span class="line"><span class="cl">sudo wipefs -af <span class="nv">$DISK3</span>
</span></span><span class="line"><span class="cl">sudo wipefs -af <span class="nv">$DISK4</span>
</span></span><span class="line"><span class="cl">sudo wipefs -af <span class="nv">$DISK5</span></span></span></code></pre></div>
</div>
<p>
Now the last bit missing is the partition layout:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo sgdisk -n3:1M:+512M -t3:EF00 <span class="nv">$DISK1</span>
</span></span><span class="line"><span class="cl">sudo sgdisk -n1:0:0 -t1:BF01 <span class="nv">$DISK1</span></span></span></code></pre></div>
</div>
<p>
After this we just copy it to the other drives:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo sfdisk --dump <span class="nv">$DISK1</span> <span class="p">|</span> sudo sfdisk <span class="nv">$DISK2</span>
</span></span><span class="line"><span class="cl">sudo sfdisk --dump <span class="nv">$DISK1</span> <span class="p">|</span> sudo sfdisk <span class="nv">$DISK3</span>
</span></span><span class="line"><span class="cl">sudo sfdisk --dump <span class="nv">$DISK1</span> <span class="p">|</span> sudo sfdisk <span class="nv">$DISK4</span>
</span></span><span class="line"><span class="cl">sudo sfdisk --dump <span class="nv">$DISK1</span> <span class="p">|</span> sudo sfdisk <span class="nv">$DISK5</span></span></span></code></pre></div>
</div>
<div id="outline-container-headline-61" class="outline-5">
<h5 id="headline-61">
Formatting
</h5>
<div id="outline-text-headline-61" class="outline-text-5">
<div id="outline-container-headline-62" class="outline-6">
<h6 id="headline-62">
Boot
</h6>
<div id="outline-text-headline-62" class="outline-text-6">
<p>
Starting with the boot partition:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo mkfs.vfat <span class="nv">$DISK1</span>-part3
</span></span><span class="line"><span class="cl">sudo mkfs.vfat <span class="nv">$DISK2</span>-part3
</span></span><span class="line"><span class="cl">sudo mkfs.vfat <span class="nv">$DISK3</span>-part3
</span></span><span class="line"><span class="cl">sudo mkfs.vfat <span class="nv">$DISK4</span>-part3
</span></span><span class="line"><span class="cl">sudo mkfs.vfat <span class="nv">$DISK5</span>-part3</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-63" class="outline-6">
<h6 id="headline-63">
ZFS
</h6>
<div id="outline-text-headline-63" class="outline-text-6">
<p>
Considering that I want two disk parity on my setup, I&#39;m going with a <em>raidz2</em> pool.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo zpool create -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">dnodesize</span><span class="o">=</span>auto <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">normalization</span><span class="o">=</span>formD <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">acltype</span><span class="o">=</span>posixacl <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">xattr</span><span class="o">=</span>sa <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">mountpoint</span><span class="o">=</span>none <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">compression</span><span class="o">=</span>lz4 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  -O <span class="nv">recordsize</span><span class="o">=</span>1M <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  zroot raidz2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>                  <span class="nv">$DISK1</span>-part1 <span class="nv">$DISK2</span>-part1 <span class="nv">$DISK3</span>-part1 <span class="nv">$DISK4</span>-part1 <span class="nv">$DISK5</span>-part1</span></span></code></pre></div>
</div>
<p>
And the following datasets:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>none zroot/root
</span></span><span class="line"><span class="cl">sudo zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy zroot/root/nixos
</span></span><span class="line"><span class="cl">sudo zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy zroot/var
</span></span><span class="line"><span class="cl">sudo zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy zroot/var/media
</span></span><span class="line"><span class="cl">sudo zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy zroot/var/torrents
</span></span><span class="line"><span class="cl">sudo zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy zroot/var/samba
</span></span><span class="line"><span class="cl">sudo zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy zroot/home</span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-64" class="outline-5">
<h5 id="headline-64">
Mounting everything together
</h5>
<div id="outline-text-headline-64" class="outline-text-5">
<p>
Mounting is the easiest part of the whole process. However, we need the directories to be there in the first place.</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo mount -t zfs zroot/root/nixos /mnt
</span></span><span class="line"><span class="cl">sudo mkdir /mnt/home
</span></span><span class="line"><span class="cl">sudo mkdir -p /mnt/var/lib/<span class="o">{</span>torrents,media,samba<span class="o">}</span>
</span></span><span class="line"><span class="cl">sudo mkdir /mnt/boot</span></span></code></pre></div>
</div>
<p>
Now it&#39;s just a matter of <em>mapping</em> everything to the right place:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo mount -t zfs zroot/home /mnt/home
</span></span><span class="line"><span class="cl">sudo mount -t zfs zroot/var /mnt/var
</span></span><span class="line"><span class="cl">sudo mount -t zfs zroot/var/media /mnt/var/lib/media
</span></span><span class="line"><span class="cl">sudo mount -t zfs zroot/var/torrents /mnt/var/lib/torrents
</span></span><span class="line"><span class="cl">sudo mount -t zfs zroot/var/samba /mnt/var/lib/samba
</span></span><span class="line"><span class="cl">sudo mount <span class="nv">$DISK1</span>-part3 /mnt/boot</span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-65" class="outline-4">
<h4 id="headline-65">
Finishing up
</h4>
<div id="outline-text-headline-65" class="outline-text-4">
<p>
The only step left is to generate the NixOS configuration with the filesystem layout and install the system:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo nixos-generate-config --root /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># don&#39;t forget to get your machine id and put it on `networking.hostId`</span>
</span></span><span class="line"><span class="cl">head -c <span class="m">8</span> /etc/machine-id
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo nixos-install</span></span></code></pre></div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-66" class="outline-3">
<h3 id="headline-66">
Debian&#39;s blank screen after suspending on Thinkpad T495
</h3>
<div id="outline-text-headline-66" class="outline-text-3">
<div class="description-block">
<p>How I fixed the issue of getting a blank screen after suspending on Debian 11.</p>
</div>
<p>
<strong>tl;dr:</strong> <code>sudo apt install firmware-amd-graphics</code></p>
<p>
After working on a huge legacy project that demanded a beefy desktop
at the company I can finally work from my laptop through Virtual
Machines. These are the specs for it:</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">CPU: AMD Ryzen 7 PRO 3700U
</span></span><span class="line"><span class="cl">RAM: 40GB
</span></span><span class="line"><span class="cl">DISK: 1TB NVMe SSD</span></span></code></pre></div>
</div>
<p>
It&#39;s not news that I love NixOS and run it on all my devices. However,
for some reason I can&#39;t really explain or reason upon, I prefer to run
<a href="https://www.debian.org/">Debian</a> on my laptop. I went ahead and
installed it but… after letting it sit for a few minutes I faced an
issue: resuming from <em>Suspend</em> gave me a blank screen with no option
out of it other than force rebooting.</p>
<p>
After a <strong>long</strong> research and multiple attempts testing some <code>GRUB_CMDLINE_LINUX</code><sup class="footnote-reference"><a id="footnote-reference-19" href="#footnote-19">19</a></sup> arguments, I finally found the solution:</p>
<div class="src src-text">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">sudo apt install firmware-amd-graphics</span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-67" class="outline-3">
<h3 id="headline-67">
Custom JWT Authentication with F# and ASP.NET
</h3>
<div id="outline-text-headline-67" class="outline-text-3">
<p>
At my <code>$CURRENT_JOB</code> we are working on introducing a new back-end
service, and as usual, teams entirely composed of new-ish employees
face some hard time discovering all the small pieces required to make
the gears turn.</p>
<p>
This time the challenge was to implement the authentication layer. It
is actually quite simple as it is just a <em>regular JWT</em> token, but the
devil&#39;s in the details:</p>
<ul>
<li>the token is on a custom header called `x-jwt-payload`</li>
<li>the token does not contain the <code>alg</code> attribute</li>
<li>the validation is done internally at the reverse proxy level</li>
</ul>
<p>OK, this doesn&#39;t sound <em>too</em> bad. However, it does take some tools
from our hands… ASP.NET has the <a href="https://devblogs.microsoft.com/dotnet/jwt-validation-and-authorization-in-asp-net-core/">UseJwtBearerAuthentication
middleware</a> that would take care of this workflow for us, but this
requires access to the <em>Authority</em><sup class="footnote-reference"><a id="footnote-reference-20" href="#footnote-20">20</a></sup> server which we don&#39;t have,
and also requires the <code>alg</code> attribute to decode the token.</p>
<p>
Having said that, let&#39;s develop another middleware to take of our
authentication. I tried to reach the official documentation on how to
write a custom authentication scheme for ASP.NET but it was less than
useless. Then I tried to reach for blog posts, Stack Overflow
questions and open source projects, but they all seemed so convoluted
for such a small feature… When I was almost going to <em>brute force</em>
the solution out of my IDE through auto completion and debugging, <a href="https://stackoverflow.com/a/46568439">this
answer</a> appeared!</p>
<p>
That&#39;s it! This is what I needed, a really concise example going
through each step of the authentication workflow. I wonder why
Microsoft doesn&#39;t have something like this on their docs. Or at least
not something easy to find there.</p>
<p>
Alright, time to implement piece by piece of this code. Starting with
the Authentication scheme definition:</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl">  <span class="k">type</span> <span class="nc">CustomJwtAuthenticationOptions</span><span class="bp">()</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">inherit</span> <span class="n">AuthenticationSchemeOptions</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">DefaultScheme</span> <span class="o">=</span> <span class="s">&#34;CustomJwtAuthentication&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">member</span> <span class="n">this</span><span class="p">.</span><span class="nf">HeaderName</span> <span class="o">=</span> <span class="s">&#34;x-jwt-payload&#34;</span></span></span></code></pre></div>
</div>
<p>
The next missing part is the <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.authenticationhandler-1?view=aspnetcore-7.0">Authentication Handler</a>. For this, I&#39;ll
use the great <a href="https://demystifyfp.gitbook.io/fstoolkit-errorhandling">FsToolkit.ErrorHandling</a> package to help structure the
code, so do a <code>dotnet add package FsToolkit.ErrorHandling</code>.</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl">  <span class="k">type</span> <span class="nc">CustomJwtAuthenticationHandler</span>
</span></span><span class="line"><span class="cl">      <span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">options</span><span class="o">:</span> <span class="n">IOptionsMonitor</span><span class="o">&lt;</span><span class="n">CustomJwtAuthenticationOptions</span><span class="o">&gt;,</span>
</span></span><span class="line"><span class="cl">          <span class="n">logger</span><span class="o">:</span> <span class="n">ILoggerFactory</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">encoder</span><span class="o">:</span> <span class="n">UrlEncoder</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">          <span class="n">clock</span><span class="o">:</span> <span class="n">ISystemClock</span>
</span></span><span class="line"><span class="cl">      <span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">inherit</span> <span class="n">AuthenticationHandler</span><span class="o">&lt;</span><span class="n">CustomJwtAuthenticationOptions</span><span class="o">&gt;(</span><span class="n">options</span><span class="o">,</span> <span class="n">logger</span><span class="o">,</span> <span class="n">encoder</span><span class="o">,</span> <span class="n">clock</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">HandleAuthenticationAsync</span><span class="bp">()</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">          <span class="n">result</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">let!</span> <span class="nv">token</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">RetrieveTokenValue</span> <span class="n">this</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">HeaderName</span>
</span></span><span class="line"><span class="cl">              <span class="k">let!</span> <span class="nv">jwt</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">DecodeToken</span> <span class="n">token</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="k">let</span> <span class="nv">name</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                  <span class="k">let</span> <span class="nv">firstName</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                      <span class="n">jwt</span><span class="o">.</span><span class="n">Item</span><span class="o">(</span><span class="s">&#34;firstName&#34;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">                  <span class="k">let</span> <span class="nv">lastName</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                      <span class="n">jwt</span><span class="o">.</span><span class="n">Item</span><span class="o">(</span><span class="s">&#34;lastName&#34;</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  <span class="o">$</span><span class="s">&#34;{firstName} {LastName}&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="k">let</span> <span class="nv">claims</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                  <span class="o">[</span> <span class="n">Claim</span><span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">NameIdentifier</span><span class="o">,</span> <span class="n">jwt</span><span class="o">.</span><span class="n">Sub</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Claim</span><span class="o">(</span><span class="nn">ClaimTypes</span><span class="p">.</span><span class="n">Name</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="k">let</span> <span class="nv">claimIdentity</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                  <span class="n">ClaimsIdentity</span><span class="o">(</span><span class="n">claims</span><span class="o">,</span> <span class="n">this</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">DefaultSchemeName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="k">let</span> <span class="nv">ticket</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                  <span class="n">AuthenticationTicket</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                      <span class="n">ClaimsPrincipal</span><span class="o">(</span><span class="n">claimsIdentity</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">AuthenticationProperties</span><span class="bp">()</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">this</span><span class="o">.</span><span class="n">Options</span><span class="o">.</span><span class="n">DefaultSchemeName</span>
</span></span><span class="line"><span class="cl">                  <span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="k">return</span> <span class="nn">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="o">(</span><span class="nn">AuthenticateResult</span><span class="p">.</span><span class="n">Success</span><span class="o">(</span><span class="n">ticket</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">          <span class="o">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">|&gt;</span> <span class="k">function</span>
</span></span><span class="line"><span class="cl">              <span class="o">|</span> <span class="n">Ok</span> <span class="n">value</span> <span class="o">-&gt;</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">              <span class="o">|</span> <span class="n">Error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="nn">Task</span><span class="p">.</span><span class="n">FromResult</span><span class="o">(</span><span class="nn">AuthenticateResult</span><span class="p">.</span><span class="n">Fail</span><span class="o">(</span><span class="n">e</span><span class="o">))</span></span></span></code></pre></div>
</div>
<p>
And that&#39;s it! I now have the custom JWT authentication I needed for
my ASP.NET application. Of course, we are missing some helper methods
I used on the code. Let&#39;s take a look at them.</p>
<p>
This function is used to extract the Base 64 token from the header.</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl">  <span class="k">member</span> <span class="k">private</span> <span class="n">this</span><span class="o">.</span><span class="n">RetrieveTokenValue</span> <span class="n">name</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">let</span> <span class="nv">found</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">          <span class="n">this</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Headers</span><span class="o">.</span><span class="n">TryGetValue</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">          <span class="n">Error</span> <span class="o">$</span><span class="s">&#34;Missing header &#39;{name}&#39;&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span>
</span></span><span class="line"><span class="cl">          <span class="n">value</span><span class="o">.</span><span class="n">ToString</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">          <span class="o">|&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span>
</span></span><span class="line"><span class="cl">          <span class="o">|&gt;</span> <span class="k">function</span>
</span></span><span class="line"><span class="cl">              <span class="o">|</span> <span class="k">false</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">              <span class="o">|</span> <span class="k">true</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="o">$</span><span class="s">&#34;Missing header &#39;{name}&#39; value&#34;</span></span></span></code></pre></div>
</div>
<p>
Now the function responsible to decode the JWT token itself.</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl">  <span class="k">member</span> <span class="k">private</span> <span class="n">this</span><span class="o">.</span><span class="n">DecodeToken</span> <span class="n">token</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span>
</span></span><span class="line"><span class="cl">          <span class="k">let</span> <span class="nv">jwt</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">              <span class="n">token</span>
</span></span><span class="line"><span class="cl">              <span class="o">|&gt;</span> <span class="nn">Convert</span><span class="p">.</span><span class="n">FromBase64String</span>
</span></span><span class="line"><span class="cl">              <span class="o">|&gt;</span> <span class="nn">Encoding</span><span class="p">.</span><span class="nn">UTF8</span><span class="p">.</span><span class="n">GetString</span>
</span></span><span class="line"><span class="cl">              <span class="o">|&gt;</span> <span class="nn">Jwt</span><span class="p">.</span><span class="nn">JwtPayload</span><span class="p">.</span><span class="n">Deserialize</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="n">Ok</span> <span class="n">jwt</span>
</span></span><span class="line"><span class="cl">      <span class="k">with</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="kt">exn</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="o">$</span><span class="s">&#34;Error decoding token: {exn.Message}&#34;</span></span></span></code></pre></div>
</div>
<p>
OK, <strong>now</strong> we have everything needed to use our brand new
authentication scheme. How can we plug this together on our
application&#39;s startup? Considering that we&#39;re using <a href="https://saturnframework.org/">Saturn</a> to
configure it, it would look just like this:</p>
<div class="src src-fsharp">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fsharp" data-lang="fsharp"><span class="line"><span class="cl">  <span class="k">let</span> <span class="nv">configureApp</span> <span class="o">(</span><span class="n">app</span><span class="o">:</span> <span class="n">IApplicationBuilder</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">app</span><span class="o">.</span><span class="n">UseAuthentication</span><span class="bp">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">let</span> <span class="nv">configureServices</span> <span class="o">(</span><span class="n">services</span><span class="o">:</span> <span class="n">IServiceCollection</span><span class="o">)</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">services</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">AddAuthentication</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">CustomJwtAuthenticationOptions</span><span class="bp">()</span><span class="o">.</span><span class="n">DefaultScheme</span>
</span></span><span class="line"><span class="cl">          <span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">.</span><span class="n">AddScheme</span><span class="o">&lt;</span><span class="n">CustomJwtAuthenticationOptions</span><span class="o">,</span> <span class="n">CustomJwtAuthenticationHandler</span><span class="o">&gt;(</span>
</span></span><span class="line"><span class="cl">              <span class="n">CustomJwtAuthenticationOptions</span><span class="bp">()</span><span class="o">.</span><span class="n">DefaultScheme</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="n">options</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">|&gt;</span> <span class="n">ignore</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">services</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">let</span> <span class="nv">main</span> <span class="o">_</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">let</span> <span class="nv">app</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">          <span class="n">application</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="n">app_config</span> <span class="n">configureApp</span>
</span></span><span class="line"><span class="cl">              <span class="n">service_config</span> <span class="n">configureServices</span>
</span></span><span class="line"><span class="cl">          <span class="o">}</span>
</span></span><span class="line"><span class="cl">          <span class="n">run</span> <span class="n">app</span></span></span></code></pre></div>
</div>
</div>
</div>
<div id="outline-container-headline-68" class="outline-3">
<h3 id="headline-68">
Setting up my new Synology DS1520+
</h3>
<div id="outline-text-headline-68" class="outline-text-3">
<div class="description-block">
<p>Using a Virtual Machine and Docker containers to setup my Synology
home server.</p>
</div>
<p title="The DS1520+, 5x4TB IronWolf ST4000VN008 and 1TB SKC3000S1024G NVMe. (2022-12-26)"><a href="/img/2022-12-26-synology.webp">/img/2022-12-26-synology.webp</a></p>
<p>
Some time ago <a href="*Building a Dell PowerEdge T410 NAS with NixOS and ZFS">I built a NAS for personal usage</a>. It has been a blessing
in my life as I&#39;m not afraid of losing data or going out of storage
anymore. However, due to some unfortunate events, I don&#39;t have a place
to run it other than my bedroom, but it is too noisy to keep it beside
my bed.</p>
<p>
I decided to migrate the server to a smaller form so that I could rest
comfortable without a running computer on my ears. Interestingly, in
Brazil we don&#39;t have much options for small factor cases such as ITX.
Considering that I wouldn&#39;t be able to build it my own, I decided to
go with a Synology DS1520+.</p>
<div id="outline-container-headline-69" class="outline-4">
<h4 id="headline-69">
Software
</h4>
<div id="outline-text-headline-69" class="outline-text-4">
<p>
Now, I&#39;m going to be honest here, the software is absolutely awesome.
Personally, I don&#39;t like to use closed-source software (and I&#39;ll show
you one of the reasons in a few moments), but the disk and backup
management is way better than something I could come up with. I don&#39;t
know how long they will support my model and its software but for the
time being I&#39;m enjoying it.</p>
<p>
Partitioning and formatting was always a struggle for me as I can&#39;t
decide for myself if I should go with Btrfs or ZFS; which RAID setup
or how many datasets to create. This was all automatically handled for
me.</p>
</div>
</div>
<div id="outline-container-headline-70" class="outline-4">
<h4 id="headline-70">
Hardware
</h4>
<div id="outline-text-headline-70" class="outline-text-4">
<p>
This is the part that sucks the most about the device. I mean, the
hardware is definitely reasonable for its original use case: file
storage. It has a <a href="https://www.intel.com/content/www/us/en/products/sku/197305/intel-celeron-processor-j4125-4m-cache-up-to-2-70-ghz/specifications.html">Celeron J4125</a> with 8GB DDR4 ECC RAM (up to 20GB).
This is more than enough for my needs.</p>
<p>
What about the noise? I can&#39;t hear it at all! The only noise that it
introduces to the room is actually from it hard-drives, but nothing
loud enough to disrupt my sleep as it&#39;s barely noticeable.</p>
<p>
Something that I think I shouldn&#39;t have bought is the NVMe drive for
caching. I thought that by running a bunch of media software I&#39;d get
better performance caching reads on the SSD. Well, it turns out that I
don&#39;t actually have this much reads and I only hit a cache of 5GB on a
daily-basis.</p>
</div>
</div>
<div id="outline-container-headline-71" class="outline-4">
<h4 id="headline-71">
What about the containers?
</h4>
<div id="outline-text-headline-71" class="outline-text-4">
<p>
Synology provides an official Docker application at its <em>Package
Center</em> that you can just install and go crazy with it… or not. I
might have done everything wrong and tried to circumvent the software
in a way that is not recommended. However, every time I tried to run a
container that exposes an HTTP server, I got redirected to the port
<code>5000</code> by my device&#39;s NGINX. I spent a ridiculous amount of time
trying to change this behavior but I thought that it would be easier
to setup this in a way that I&#39;m used to.</p>
<div id="outline-container-headline-72" class="outline-5">
<h5 id="headline-72">
Alpine Linux for the rescue
</h5>
<div id="outline-text-headline-72" class="outline-text-5">
<p>
Feeling defeated by Synology&#39;s software, I decided to try a <em>different
approach</em>: a regular Linux distribution. As my
hardware is really limited, I want to use as less resources as
possible. For this reason I chose to go with <a href="https://www.alpinelinux.org/">Alpine Linux</a><sup class="footnote-reference"><a id="footnote-reference-21" href="#footnote-21">21</a></sup> as the
backbone of my virtual machine.</p>
<p>
There&#39;s nothing novel about running containers with Docker and
<code>docker-compose</code>, so I&#39;m not going to dig deeper on setting this up.</p>
<div id="outline-container-headline-73" class="outline-6">
<h6 id="headline-73">
Using NFS as the storage
</h6>
<div id="outline-text-headline-73" class="outline-text-6">
<p>
Docker has a poorly documented way of setting up an NFS share directly
on the container and due to this I assume they don&#39;t want you to use
this feature 😜. Anyway, mounting an NFS share is much easier than
going trial and error with docker volumes over NFS.</p>
<p>
I created the NFS share on Synology&#39;s dashboard and then on my alpine
machine I ran:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  mkdir -p /mnt/docker
</span></span><span class="line"><span class="cl">  mount -t nfs &lt;ip&gt;:/volume1/&lt;share-dir&gt; /mnt/docker</span></span></code></pre></div>
</div>
<p>
I also added this line on my <code>/etc/fstab</code> file to automatically mount
the NFS volume after boot:</p>
<div class="src src-shell">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  &lt;ip&gt;:/volume1/&lt;share-dir&gt; /mnt/docker nfs _netdev <span class="m">0</span> <span class="m">0</span></span></span></code></pre></div>
</div>
<p>
This might not be obvious at this point, but doing things this way is
awesome because I can just mount volumes pointing to <code>/mnt/docker</code> and
backup them through <a href="https://www.synology.com/en-global/dsm/feature/hyper_backup">Hyper Backup</a> on <a href="https://www.backblaze.com/b2/cloud-storage.html">Backblaze B2</a>.</p>
<div class="src src-yaml">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">caddy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">caddy:2.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">/mnt/docker/caddy/Caddyfile:/etc/caddy/Caddyfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># ...</span></span></span></code></pre></div>
</div>
<p>
This setup gives me the most out of everything I tried so far:</p>
<dl>
<dt>
Flexibility
</dt>
<dd>I configure my services through a regular Linux
system with extensive documentation.</dd>
<dt>
Security
</dt>
<dd>Hyper Backup assures me things are backed up correctly.</dd>
<dt>
Portability
</dt>
<dd>They are regular containers, I can easily migrate to another host</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-74" class="outline-4">
<h4 id="headline-74">
Conclusion
</h4>
<div id="outline-text-headline-74" class="outline-text-4">
<p>
My current experience has been positive. Although, I&#39;m still kind of
skeptical about the longevity of the backup software. It is easy to
use and makes incremental backups a breezy to setup, but I still want
the freedom to restore on a Linux server without much trouble. Well,
this is mostly a personal desire and I understand this device was not
made for my use case! 😁</p>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-75" class="outline-3">
<h3 id="headline-75">
New Year&#39;s Resolutions for 2023
</h3>
<div id="outline-text-headline-75" class="outline-text-3">
<div class="description-block">
<p>My <em>glorified</em> to-do list for 2023</p>
</div>
<p>
I have never done a New Year&#39;s resolution before… well, at least not
a public one written down in a blog post! 😁</p>
<ul>
<li>
<p>Content</p>
<ul>
<li>More blog posts</li>
<li>Write more software (if possible, in F#)</li>
<li>Take more pictures</li>
</ul>
</li>
<li>
<p>Habits</p>
<ul>
<li>Turn <a href="https://www.gwern.net/Spaced-repetition">spaced repetition</a> into a habit</li>
<li>Read at least a book each month</li>
</ul>
</li>
<li>
<p>Knowledge</p>
<ul>
<li>Be able to hold at least a basic conversation in French</li>
</ul>
</li>
<li>
<p>Gym-related goals</p>
<dl>
<dt>
Squat
</dt>
<dd>150kg for 5 reps.</dd>
<dt>
Deadlift
</dt>
<dd>200kg MR.</dd>
<dt>
Benchpress
</dt>
<dd>100kg for 5 reps.</dd>
<dt>
Overhead Press
</dt>
<dd>60kg for 5 reps.</dd>
</dl>
</li>
<li>
<p>Travel-related goals</p>
<dl>
<dt>
Nationally
</dt>
<dd>Visit <a href="https://en.wikipedia.org/wiki/Ouro_Preto">Ouro Preto</a>; visit São Paulo&#39;s countryside;
discover new restaurants</dd>
<dt>
Internationally
</dt>
<dd>Visit Japan or an European country</dd>
</dl>
</li>
</ul>
<p>Being completely honest, this is a lot for a single year. Even more for the traveling part.
But, it&#39;s how they say: <em>go big or go home</em>!</p>
</div>
</div>
<div id="outline-container-headline-76" class="outline-3">
<h3 id="headline-76">
<span class="todo">TODO</span>
Photo dump - (2022-09-17)
</h3>
<div id="outline-text-headline-76" class="outline-text-3">
<p>
On September 17th 2022 I had a meal with my beloved nana on a Vietnamese
restaurant called Phoviet located at <em>Alameda Santos, 1202 - Jardim Paulista,
São Paulo - SP, 01418-100</em> and after that went for a quick walk on Avenida
Paulista.</p>
</div>
</div>
<div id="outline-container-headline-77" class="outline-3">
<h3 id="headline-77">
<span class="todo">TODO</span>
Photo dump - (2022-10-30)
</h3>
</div>
</div>
</div>
<div id="outline-container-headline-78" class="outline-2">
<h2 id="headline-78">
Footnotes
</h2>
</div>
<div class="footnotes">
<hr class="footnotes-separatator">
<div class="footnote-definitions">
<div class="footnote-definition">
<sup id="footnote-1"><a href="#footnote-reference-1">1</a></sup>
<div class="footnote-body">
<p><a href="https://commonmark.org/">https://commonmark.org/</a></p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-2"><a href="#footnote-reference-2">2</a></sup>
<div class="footnote-body">
<p>This post did indeed deteriorate quickly as 2 years later I&#39;m writing this blog on <a href="https://www.gnu.org/software/emacs/">GNU Emacs</a> with <a href="https://orgmode.org/">Org Mode</a> + <a href="https://ox-hugo.scripter.co/">ox-hugo</a> and hosting it on <a href="https://srht.site/">sourcehut pages</a>.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-3"><a href="#footnote-reference-3">3</a></sup>
<div class="footnote-body">
<p><a href="https://nixos.org">https://nixos.org</a></p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-4"><a href="#footnote-reference-4">4</a></sup>
<div class="footnote-body">
<p><a href="https://nixos.wiki/wiki/NixOS_on_ARM/Raspberry_Pi_4#Configuration">https://nixos.wiki/wiki/NixOS_on_ARM/Raspberry_Pi_4#Configuration</a></p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-5"><a href="#footnote-reference-5">5</a></sup>
<div class="footnote-body">
<p><a href="https://blog.replit.com/nix">https://blog.replit.com/nix</a></p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-6"><a href="#footnote-reference-6">6</a></sup>
<div class="footnote-body">
<p><a href="https://shopify.engineering/what-is-nix">https://shopify.engineering/what-is-nix</a></p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-7"><a href="#footnote-reference-7">7</a></sup>
<div class="footnote-body">
<p><a href="https://hercules-ci.com/">https://hercules-ci.com/</a></p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-8"><a href="#footnote-reference-8">8</a></sup>
<div class="footnote-body">
<p>For the past few weeks it has been even better with the work of
<a href="https://github.com/thiagokokada">github:thiagokokada</a> on the <a href="https://github.com/nix-community/nix-doom-emacs/">github:nix-community/nix-doom-emacs</a> repository.
Really, kudos for taking care of this project! 🎉</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-9"><a href="#footnote-reference-9">9</a></sup>
<div class="footnote-body">
<p><a href="id:143b30fd-8d32-4e67-9e13-5bf8a47ea8e2">Starting a personal monorepo</a></p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-10"><a href="#footnote-reference-10">10</a></sup>
<div class="footnote-body">
<p>I&#39;ve never learned how to touch type correctly and as such I only use at most 3 fingers on each hand.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-11"><a href="#footnote-reference-11">11</a></sup>
<div class="footnote-body">
<p><a href="https://github.com/yuri-potatoq">Yuri</a> was the friend of mine that bought it and actually liked to type on it. Different people, different switch tastes. 😊</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-12"><a href="#footnote-reference-12">12</a></sup>
<div class="footnote-body">
<p>Most known as a 75% layout.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-13"><a href="#footnote-reference-13">13</a></sup>
<div class="footnote-body">
<p>I fixed this with a cheap <a href="https://pt.aliexpress.com/item/32946133227.html">keyset from AliExpress</a> that meant to go to my Corne V3.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-14"><a href="#footnote-reference-14">14</a></sup>
<div class="footnote-body">
<p>It has been my first <em>production</em> encounter with functional programming and I&#39;m loving it! 🤓</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-15"><a href="#footnote-reference-15">15</a></sup>
<div class="footnote-body">
<p>This hardware is actually overkill for this build but I couldn&#39;t find anything better for such a price.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-16"><a href="#footnote-reference-16">16</a></sup>
<div class="footnote-body">
<p>Unfortunately my machine arrived with a Dell PERC 6/i that has a 2TB per disk limit.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-17"><a href="#footnote-reference-17">17</a></sup>
<div class="footnote-body">
<p>Unfortunately hard drives are <strong>really</strong> expensive in Brazil due to taxes… a ~$35 drive costing near $200 is just insane!</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-18"><a href="#footnote-reference-18">18</a></sup>
<div class="footnote-body">
<p>A lot of people use the LSI 9240-8I HBA on regular desktops.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-19"><a href="#footnote-reference-19">19</a></sup>
<div class="footnote-body">
<p>Did you know that setting <code>splash</code> on <code>GRUB_CMDLINE_LINUX_DEFAULT</code> gives you a cute splash screen instead of a tty asking for your password to unlock your encrypted partition?</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-20"><a href="#footnote-reference-20">20</a></sup>
<div class="footnote-body">
<p>The address of the token-issuing authentication server. The JWT bearer authentication middleware will use this URI to find and retrieve the public key that can be used to validate the token’s signature. It will also confirm that the iss parameter in the token matches this URI.</p>
</div>
</div>
<div class="footnote-definition">
<sup id="footnote-21"><a href="#footnote-reference-21">21</a></sup>
<div class="footnote-body">
<p>They even provide an image made specifically for virtualization! 🎉</p>
</div>
</div>
</div>
</div>

<footer>
    <p><em>
        Have something to say about this? Feel free to send me an email at
        <a href="mailto:~glorifiedgluer/inbox@lists.sr.ht">my inbox</a>!
    </em></p>
</footer>

      </main>
    </main>
  </body>
</html>
