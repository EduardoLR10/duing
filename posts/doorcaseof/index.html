<!DOCTYPE html>
<html class="" lang="en"><head>
    
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=7" />

    <link
    rel="icon"
    href='/favicon.png'
/>
<link
    rel="shortcut icon"
    href='/favicon.ico'
    type="image/x-icon"
/>
<link
    rel="apple-touch-icon"
    href='/apple-touch-icon.png'
/>

    <link
        rel="icon"
        href='/logo.svg'
        type="image/svg+xml"
    />

<title>
        
            Do or Case of; there is no Try  &ndash;
        
        Duing Dev
    </title>

    
    <link href="/symbols-nerd-font/symbols-nerd-font.css" rel="stylesheet" integrity="sha512-lydow8GLOLlYNOtHlksNCmGWWCBsbIEtikXpHzfWqx78HLlyQZHOzyLwPpKol4Th6aCwLUXOfODVYgwrd3nwKQ=="/>
    <link href="/jetbrains-mono/jetbrains-mono.css" rel="stylesheet" integrity="sha512-tJxlgL6v1Y7kFf+qB8SloaAMKnOAw6WouknxXtIjkBux9Y/9aX81EUWOJO8c/3l98DmjG8brr4to7zaez606Fg=="/>

    
    
    <link type="text/css" rel="stylesheet" href=https://duing.dev/css/styles.6f7510796ff02c7dabd794e74edd5fe8768c226a0caad05f3838da994c532544d6915ce65b106ca5a210796f2936429e8446811360103cd082ad0dc245016d71.css integrity="sha512-b3UQeW/wLH2r15TnTt1f6HaMImoMqtBfODjamUxTJUTWkVzmWxBspaIQeW8pNkKehEaBE2AQPNCCrQ3CRQFtcQ==" />
<meta name="author" content="Eduardo Lemos Rocha" />

    
        <meta name="keywords" content='technical' />
    
    
        <meta name="description" content="to a recent experience I had when playing with erlando &amp;ndash; an Erlang library that adds a set of syntax extensions to the language. In particular, it adds a more-less Haskell&amp;rsquo;s do-notation equivalent in Erlang.
With the purpose of re-iterating the message from Don&amp;rsquo;t make all defaults Dogmas, I&amp;rsquo;m here to show another computer science abstraction that goes beyond a particular community or programming language ecosystem: monads." />
    

<meta property="og:site_name"
    content='Duing Dev' />

    <meta property="og:title" content="Do or Case of; there is no Try" />
    <meta property="og:type" content="article" />
    
    <meta
        property="article:author" content="Eduardo Lemos Rocha" />
    <meta
        property="article:published_time"
        content='2024-11-28T00:00:00Z&#43;0000' />
    
        
            <meta property="article:tag" content="technical" />
        
    
    <meta property="og:url" content="https://duing.dev/posts/doorcaseof/" />
    
    
    <meta property="og:image"
        content="https://duing.dev/img/icon.svg" />
    
        <meta property="og:description" content="Today I will dive into a recent experience I had when playing with erlando &amp;ndash; an Erlang library that adds a set of syntax extensions to the language. In pa" />
    

<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:domain"
      content='duing.dev'
/>
<meta property="twitter:url" content="https://duing.dev/posts/doorcaseof/" />


    <meta name="twitter:title" content="Do or Case of; there is no Try" />
    
    
    
    <meta name="twitter:image"
        content="https://duing.dev/img/icon.svg" />
    
        <meta name="twitter:description" content="Today I will dive into a recent experience I had when playing with erlando &amp;ndash; an Erlang library that adds a set of syntax extensions to the language. In pa" />
    

<link rel="manifest" href="/manifest/index.json" />
</head>


<body>
        <div id="baseContainer"><header class="">
<div class="titleAndSearchContainer">
        <div id="titleContainer">
            
                <a class="unstyledLink" href="/">
                    <img src='/logo.svg' alt='Logo'/>
                </a>
            
            <div class="rightOfLogo">
                <div class="titleAndHamburger">
                    <h1>
                        <a class="unstyledLink" href="/">Duing Dev</a>
                        
                    </h1>
                    
                </div>
                <div id="wide_nav"><nav>
    
    <ul id="main-nav">
        <li><a href="/">Home</a></li>
        
            <li><a href="/posts">Posts</a></li>
        
        
        
        
        
            <li><a href="https://duing.dev/publications/">
                Publications
            </a></li>
        
            <li><a href="https://duing.dev/about/">
                About
            </a></li>
        
        
        
            <li><a href="/tags">Tags</a></li>
        
        
    </ul>
</nav>
</div>
            </div>
        </div>
        
    </div>
    <div id="links">
        
        
        <a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="mailto:dudulr10@gmail.com">
    
    
        &#xf6ed;
    
    <span>
        Email
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://github.com/EduardoLR10">
    
    
        &#xf09b;
    
    <span>
        GitHub
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://discordapp.com/users/246675375877390337">
    
    
        &#xfb6e;
    
    <span>
        Discord
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.linkedin.com/in/eduardo-lemos-rocha-3198a5149/">
    
    
        &#xf0e1;
    
    <span>
        Linkedin
    </span>
</a>
<a
    
        rel="noreferrer"
    
    target="_blank"
    class="nerdlink"
    href="https://www.youtube.com/channel/UCMyzdYsPiBU3xoqaOeahr6Q">
    
    
        &#xf16a;
    
    <span>
        Dr.Nekoma
    </span>
</a>

    </div>
    

</header>
<div id="contentContainer">
                <div id="content">
                    <main>
<article class="card single">
    
        <h1>Do or Case of; there is no Try</h1>
    
    
        <p class="date">
            <span title='Date'>ï—¬ </span>
    2024-11-28

</p>
    
    
    
    
    <div><p>Today I will dive into a recent experience I had when playing with <a href="https://github.com/rabbitmq/erlando">erlando</a> &ndash; an Erlang
library that adds a set of syntax extensions to the language. In particular, it adds a more-less
Haskell&rsquo;s <em>do-notation</em> equivalent in Erlang.</p>
<p>With the purpose of re-iterating the message from <a href="../defaultsarenotdogmas/">Don&rsquo;t make all defaults Dogmas</a>, I&rsquo;m here to show another computer science
abstraction that goes beyond a particular community or programming language ecosystem: <strong>monads</strong>. Despite
its negative popularity (a lot of the time undeserved), monads in some degree and/or scope can heavily
improve your code&rsquo;s maintanability and readability, assuming everyone involved and any future hires will know
how to deal with them.</p>
<p>A great sign that an abstraction is not exclusive to a particular implementation or ecosystem is if it can be
represented without any type of programming jargon; a mere drawing does the job just fine &ndash; sometimes even
simple enough that people outside of our programming or mathematical bubbles can understand. And I do believe this is the
case for monads; you can find hints of them in many places. Hopefully at the end of this post, you will agree
that its idea is useful regardless of any specific implementation, and however many problems the implementations introduce.</p>
<h2 id="case-menace">Case Menace</h2>
<p>Our story begins with me unsatisfied with particular parts of a project of mine. The project is <a href="https://github.com/Dr-Nekoma/lyceum">Lyceum</a> &ndash; an MMO I&rsquo;ve
been developing with close friends. In there, we use a PGSQL library for Erlang, <a href="https://github.com/epgsql/epgsql">epgsql</a>, to interact with our database
instance. A lot of the time we want to do multiple queries into the database and compose our payload and dispatch it to the client;
sending it only if everything did not fail. An initial naive approach would be to just:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  character_map(Pid, MapName, Credentials, Connection) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Result <span style="color:#f92672">=</span> <span style="color:#66d9ef">case</span> database:<span style="color:#a6e22e">retrieve_character</span>(Credentials, Connection) <span style="color:#66d9ef">of</span>
</span></span><span style="display:flex;"><span>		   {ok, Character} <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>		       <span style="color:#66d9ef">case</span> database:<span style="color:#a6e22e">retrieve_map</span>(MapName, Connection) <span style="color:#66d9ef">of</span>
</span></span><span style="display:flex;"><span>			   {ok, Map} <span style="color:#f92672">-&gt;</span> {ok, {Character, Map}};
</span></span><span style="display:flex;"><span>			   {error, Reason} <span style="color:#f92672">-&gt;</span> {error, Reason}
</span></span><span style="display:flex;"><span>		       <span style="color:#66d9ef">end</span>;
</span></span><span style="display:flex;"><span>		   {error, Reason} <span style="color:#f92672">-&gt;</span> {error, Reason}
</span></span><span style="display:flex;"><span>	       <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>      Pid <span style="color:#f92672">!</span> Result.
</span></span></code></pre></div><p>Assuming our client application provided some credentials and we got a connection to our server database, above we are getting the
character for that particular user and, if everything went ok, we do another read in the database to retrieve the character&rsquo;s map
information, in order to render it on the client later. If the first query fails, we just short-circuit the entire thing and go
back to the client with an error explaining why we failed.</p>
<p>After doing that type of code enough times (or if you are used to that type of situation), a pattern starts to emerge. Many tutorials
about monads show images or diagrams to illustrate short-circuit behavior. And the intuition is simple for that particular monad: we proceed
as we keep hitting <code>ok</code>, and if we find <code>error</code> the entire thing stops and we just bubble that up to whoever called the entire process.</p>
<h2 id="attack-of-the-functions">Attack of The Functions</h2>
<p>When I realized this, I felt sad. At the time, I was not aware of any better way to handle this problem than to make auxiliary functions
to help me alleviate the burden &ndash; at least at first glance. First up, I&rsquo;ve made <code>process_postgres_result</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  process_postgres_result({ok, FullColumns, Values}, select, Fun) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Fun(FullColumns, Values);
</span></span><span style="display:flex;"><span>  process_postgres_result({ok, Count}, update, Fun) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Fun(Count);
</span></span><span style="display:flex;"><span>  process_postgres_result({ok, Count}, delete, Fun) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Fun(Count);
</span></span><span style="display:flex;"><span>  process_postgres_result({ok, Count}, insert, Fun) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Fun(Count);
</span></span><span style="display:flex;"><span>  process_postgres_result({ok, _, _, _}, insert, _) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      {error, <span style="color:#e6db74">&#34;Unexpected use of Insert on Server side&#34;</span>};
</span></span><span style="display:flex;"><span>  process_postgres_result({error, Error}, Tag, _) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      io:<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;Tag: </span><span style="color:#e6db74">~p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Error: </span><span style="color:#e6db74">~p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, [Error, Tag]),
</span></span><span style="display:flex;"><span>      {error, <span style="color:#e6db74">&#34;Unexpected error (operation or PSQL) on Server side&#34;</span>}.
</span></span></code></pre></div><p>The goal of this function was to better handle internal uses of <code>epgsql</code>. The library changes its output depending on the <em>kind</em> of
query you are executing, e.g., selects, updates, deletes, inserts, etc. So the idea would be that you call the library with your query and
immediately call this process result function informing which type of query you did and what type of treatment you want to apply with its
result (represented by <code>Fun</code> in the snippet above). Here&rsquo;s an example of using this function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  check_user(Username, Password, Connection) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Query <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#e6db74">&#34;SELECT * FROM player.record WHERE username = $1::VARCHAR(32) &#34;</span>
</span></span><span style="display:flex;"><span>	  <span style="color:#e6db74">&#34;AND password = $2::TEXT&#34;</span>,
</span></span><span style="display:flex;"><span>      Result <span style="color:#f92672">=</span> epgsql:<span style="color:#a6e22e">equery</span>(Connection, Query, [Username, Password]),
</span></span><span style="display:flex;"><span>      Fun <span style="color:#f92672">=</span> <span style="color:#66d9ef">fun</span>(FullColumns, Values) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#66d9ef">case</span> database:<span style="color:#a6e22e">columns_and_rows</span>(FullColumns, Values) <span style="color:#66d9ef">of</span>
</span></span><span style="display:flex;"><span>			[] <span style="color:#f92672">-&gt;</span> {error, <span style="color:#e6db74">&#34;Could not find User&#34;</span>};
</span></span><span style="display:flex;"><span>			[UserData | _] <span style="color:#f92672">-&gt;</span> {ok, maps:get(e_mail, UserData)}
</span></span><span style="display:flex;"><span>		    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>      database:<span style="color:#a6e22e">process_postgres_result</span>(Result, select, Fun).
</span></span></code></pre></div><p>In order to check if a user attempting to login has valid credentials, we need to performa a SQL <code>SELECT</code>. We first make the SQL query with
holes for data. Then, we call our library providing the data to fill the placeholders. Next is the treatment function: what should happen to the
data if we happen to succeed with the query? Finally, we call <code>process_postgres_result</code> accordingly. Notice here that the possible results of
our lambda <code>Fun</code> are familiar: they are the same as we saw in the previous section. And, as we make more of those queries, we plan to follow
a pattern to have reasonable expectations when calling those functions in the main program, i.e., we shall expect that all of them will respect
<code>ok</code> with the correct value or <code>error</code> with the reason for failure. There may be a few exceptions, but the rule should be clear.</p>
<h2 id="revenge-of-the-monads">Revenge of The monads</h2>
<p>Our function <code>process_postgres_result</code> allows us to more conveniently get our values; those that remind us of Haskell&rsquo;s <code>Either</code> or F#&rsquo;s <code>Result</code>.
Now it comes the question: how are we suppose to combine them? Initially, my naive previous self thought we could improve things a bit by
starting to use <code>psql_bind</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  psql_bind(monadicValue, []) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      monadicValue;
</span></span><span style="display:flex;"><span>  psql_bind(ok, _) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      ok;
</span></span><span style="display:flex;"><span>  psql_bind({ok, Result}, [Fun | Tail]) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      psql_bind(Fun(Result), Tail);
</span></span><span style="display:flex;"><span>  psql_bind({error, _} <span style="color:#f92672">=</span> Error, _) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Error;
</span></span><span style="display:flex;"><span>  psql_bind(_, _) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      {error, <span style="color:#e6db74">&#34;Wrong monadic value in the chain&#34;</span>}.
</span></span></code></pre></div><p>The purpose of this function is to allow us to pass a list of functions to keep processing values that are being called &ldquo;monadic&rdquo;. Hence, <code>psql_bind</code> would
unwrap those values for us and pipe it to the next available function or stop immediately if an error occurred. Given that we plan to use this with our
previous function, <code>process_postgres_result</code>, these two are suppose to have some chemistry together. Sadly, I was not satisfied with the end result. Here&rsquo;s
one example of using it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  character_map(Pid, MapName, Credentials, Connection) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Result <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>	  database:<span style="color:#a6e22e">psql_bind</span>(
</span></span><span style="display:flex;"><span>	    database:<span style="color:#a6e22e">retrieve_character</span>(Credentials, Connection),
</span></span><span style="display:flex;"><span>	    [<span style="color:#66d9ef">fun</span>(Character) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>		     database:<span style="color:#a6e22e">psql_bind</span>(
</span></span><span style="display:flex;"><span>		       database:<span style="color:#a6e22e">retrieve_map</span>(MapName, Connection),
</span></span><span style="display:flex;"><span>		       [<span style="color:#66d9ef">fun</span>(Map) <span style="color:#f92672">-&gt;</span> {ok, {Character, Map}} <span style="color:#66d9ef">end</span>])
</span></span><span style="display:flex;"><span>	     <span style="color:#66d9ef">end</span>]),
</span></span><span style="display:flex;"><span>      Pid <span style="color:#f92672">!</span> Result.
</span></span></code></pre></div><p>Underwhelming, isn&rsquo;t it? No matter how hard we try, the thing still looks convoluted and hardly readable. And let me tell you, it gets way worse as we progress:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  mess(..., Connection) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      database:<span style="color:#a6e22e">psql_bind</span>(
</span></span><span style="display:flex;"><span>	database:<span style="color:#a6e22e">process_postgres_result</span>(Dimensions, select, FunDimensions),
</span></span><span style="display:flex;"><span>	[<span style="color:#66d9ef">fun</span>(ListDimensionsMap) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>		 <span style="color:#66d9ef">case</span> ListDimensionsMap <span style="color:#66d9ef">of</span>
</span></span><span style="display:flex;"><span>		     [Map] <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>			 Width <span style="color:#f92672">=</span> maps:get(width, Map),
</span></span><span style="display:flex;"><span>			 Height <span style="color:#f92672">=</span> maps:get(height, Map),
</span></span><span style="display:flex;"><span>			 {ok, {Width, Height}};
</span></span><span style="display:flex;"><span>		     _ <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>			 io:<span style="color:#a6e22e">format</span>(<span style="color:#e6db74">&#34;[ERROR] Something to wrong when getting map dimensions!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>),
</span></span><span style="display:flex;"><span>			 exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		 <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>	 <span style="color:#66d9ef">fun</span>({Width, Height}) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>		 database:<span style="color:#a6e22e">psql_bind</span>(
</span></span><span style="display:flex;"><span>		   database:<span style="color:#a6e22e">process_postgres_result</span>(Tiles, select, FunTiles),
</span></span><span style="display:flex;"><span>		   [<span style="color:#66d9ef">fun</span>(TilesV) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>			    database:<span style="color:#a6e22e">psql_bind</span>(
</span></span><span style="display:flex;"><span>			      database:<span style="color:#a6e22e">process_postgres_result</span>(Objects, select, FunObjects),
</span></span><span style="display:flex;"><span>			      [<span style="color:#66d9ef">fun</span>(ObjectsV) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>				       Quantity <span style="color:#f92672">=</span> Width <span style="color:#f92672">*</span> Height,
</span></span><span style="display:flex;"><span>				       <span style="color:#66d9ef">if</span> (length(TilesV) <span style="color:#f92672">==</span> Quantity) <span style="color:#f92672">and</span> (length(ObjectsV) <span style="color:#f92672">==</span> Quantity) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>					       {ok,
</span></span><span style="display:flex;"><span>						#{tiles <span style="color:#f92672">=&gt;</span> TilesV,
</span></span><span style="display:flex;"><span>						  objects <span style="color:#f92672">=&gt;</span> ObjectsV,
</span></span><span style="display:flex;"><span>						  width <span style="color:#f92672">=&gt;</span> Width,
</span></span><span style="display:flex;"><span>						  height <span style="color:#f92672">=&gt;</span> Height}};
</span></span><span style="display:flex;"><span>					  (length(TilesV) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">or</span> (length(ObjectsV) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>					       {error, <span style="color:#e6db74">&#34;Map can&#39;t be instantiated!&#34;</span>};
</span></span><span style="display:flex;"><span>					  true <span style="color:#f92672">-&gt;</span> {error, <span style="color:#e6db74">&#34;Mismatch between dimensions, tiles and objects!&#34;</span>}
</span></span><span style="display:flex;"><span>				       <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>			       <span style="color:#66d9ef">end</span>])
</span></span><span style="display:flex;"><span>		    <span style="color:#66d9ef">end</span>])
</span></span><span style="display:flex;"><span>	 <span style="color:#66d9ef">end</span>]).
</span></span></code></pre></div><p>I will not attempt to explain what happening in the code above, but just skimming it feels terrible! The nesting makes it way
worse and even more complicated. Then, it begs the question: what is the cause of this? Is it us trying to use the wrong abstraction?
Are monads that evil? Are we just jamming it into our program to feel some empty pride about ourselves because we are using a fancy
thing that most nerds don&rsquo;t know about?</p>
<p>I don&rsquo;t think so, at all, actually. The reason we got into this situation is not because the abstraction is not expressing what we want, but
rather that the host language, Erlang in this case, makes it terse for us to express the idea that fits our problem&rsquo;s description. We are
quite literally fighting its syntax and there are consequences.</p>
<p>Now, if it is the case that this is an unavoidable problem and the end of the road, we shall consider dropping the entire idea and going back to
the drawing board. It is not because our first idea didn&rsquo;t work out that there is no better solution to this problem. It is part of intellectual
humility to recognize we made the wrong choice; regardless if we like the idea and find it cool most of the time. If it does not fit, it doesn&rsquo;t.
The arrogant decision to keep pursuing the idea knowing for a fact it can&rsquo;t be done in a way that it is worth it can have huge and devastating
consequences for any business &ndash; it may even be the main cause of its own destruction.</p>
<p>This, however, is not a fact for us in this particular use-case.</p>
<h2 id="a-new-hope">A New Hope</h2>
<p>When sharing about Lyceum in Hacker News, <a href="https://news.ycombinator.com/item?id=42107150">I did complain about this problem</a>. A fellow Erlang developer or enthusiast <a href="https://news.ycombinator.com/item?id=42108171">came to save me</a>. He mentioned
in the comment that you <em>can</em> actually make new syntax in Erlang, listing <code>erlando</code> as one example. Specifically, the library solves this problem that
I was having; I want to have nicer syntax to express PGSQL queries in a monadic way. After some digging, I&rsquo;ve found <a href="https://github.com/egobrain/erlando">a fork of the original library</a> as a package
in <code>hex</code>, something that I can use in Erlang.</p>
<p>And when looking at the <code>README</code> of <code>erlando</code>, this is the first thing I read:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  do([monad ||
</span></span><span style="display:flex;"><span>      A <span style="color:#f92672">&lt;-</span> foo(),
</span></span><span style="display:flex;"><span>      B <span style="color:#f92672">&lt;-</span> bar(A, dog),
</span></span><span style="display:flex;"><span>      ok]).
</span></span></code></pre></div><p>Are you telling me that I can not only make a <code>monad</code>, but also that there is a dedicated syntax <code>erlando</code> provides me to nicely chain operations together in
a sequence? Sounds too good to be true. And let me share with you the good news: it is true.</p>
<h2 id="the-bind-strikes-back">The Bind Strikes Back</h2>
<p>Erlando provides 3 particular syntax extensions for Erlang, one of which is a Haskell-like <code>do-notation</code>. Further, it provides some common monads that you usually
want to have around:</p>
<ul>
<li><code>error_m</code> (Haskell&rsquo;s <code>Either</code> or F#&rsquo;s <code>Result</code>)</li>
<li><code>identity_m</code> (Haskell&rsquo;s <code>Identity</code>)</li>
<li><code>list_m</code> (Haskell&rsquo;s <code>List</code>)</li>
<li><code>maybe_m</code> (Haskell&rsquo;s <code>Maybe</code>, F#&rsquo;s <code>Option</code>, OCaml&rsquo;s <code>Option</code>, Rust&rsquo;s <code>Option</code>)</li>
</ul>
<p>The idea is that you chain an operation in the same fashion we&rsquo;ve been desiring it for so long:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  if_safe_div_zero(X, Y, Fun) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      do([maybe_m ||
</span></span><span style="display:flex;"><span>	  Result <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">case</span> Y <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">of</span>
</span></span><span style="display:flex;"><span>			true  <span style="color:#f92672">-&gt;</span> fail(<span style="color:#e6db74">&#34;Cannot divide by zero&#34;</span>);
</span></span><span style="display:flex;"><span>			false <span style="color:#f92672">-&gt;</span> return(X <span style="color:#f92672">/</span> Y)
</span></span><span style="display:flex;"><span>		    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>	  return(Fun(Result))]).
</span></span></code></pre></div><p>One may say that there is no need for all of this just to check a simple division by zero. A <code>case</code> would suffice. I agree, but we can&rsquo;t diminish the potential
of this new added syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  write_file(Path, Data, Modes) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Modes1 <span style="color:#f92672">=</span> [binary, write | (Modes <span style="color:#f92672">--</span> [binary, write])],
</span></span><span style="display:flex;"><span>      do([error_m ||
</span></span><span style="display:flex;"><span>	     Bin <span style="color:#f92672">&lt;-</span> make_binary(Data),
</span></span><span style="display:flex;"><span>	     Hdl <span style="color:#f92672">&lt;-</span> file:<span style="color:#a6e22e">open</span>(Path, Modes1),
</span></span><span style="display:flex;"><span>	     Result <span style="color:#f92672">&lt;-</span> return(do([error_m ||
</span></span><span style="display:flex;"><span>				  file:<span style="color:#a6e22e">write</span>(Hdl, Bin),
</span></span><span style="display:flex;"><span>				  file:<span style="color:#a6e22e">sync</span>(Hdl)])),
</span></span><span style="display:flex;"><span>	     file:<span style="color:#a6e22e">close</span>(Hdl),
</span></span><span style="display:flex;"><span>	     Result]).
</span></span></code></pre></div><p>We are making a series of <code>IO</code> operations and if any of them fail we just finish our party &ndash; exactly the behavior that we want for our PGSQL operations.
The final piece of the puzzle is to understand how can we get this power for our custom problem. How to make it interact with <code>epgsql</code>? Can <code>erlando</code>&rsquo;s do-notation
be combined with it somehow? How to get there?</p>
<h2 id="return-of-the-do">Return of the Do</h2>
<p>The answer to this quest is the ability to make a custom <code>monad</code>. Fortunately, this is something supported by <code>erlando</code>. Hence, behold <code>postgres_m</code>! Our custom
monad can now give another flavor to our registry check function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  check_user(Username, Password, Connection) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    Query <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;SELECT * FROM player.record WHERE username = $1::VARCHAR(32) &#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;AND password = $2::TEXT&#34;</span>,
</span></span><span style="display:flex;"><span>    do([postgres_m ||
</span></span><span style="display:flex;"><span>	   UnprocessedUser <span style="color:#f92672">&lt;-</span> {epgsql:<span style="color:#a6e22e">equery</span>(Connection, Query, [Username, Password]), select},
</span></span><span style="display:flex;"><span>	   <span style="color:#66d9ef">case</span> database_utils:<span style="color:#a6e22e">columns_and_rows</span>(UnprocessedUser) <span style="color:#66d9ef">of</span>
</span></span><span style="display:flex;"><span>	       [] <span style="color:#f92672">-&gt;</span> fail(<span style="color:#e6db74">&#34;Could not find User&#34;</span>);
</span></span><span style="display:flex;"><span>	       [UserData | _] <span style="color:#f92672">-&gt;</span> return(maps:get(e_mail, UserData))
</span></span><span style="display:flex;"><span>	   <span style="color:#66d9ef">end</span>]).
</span></span></code></pre></div><p>The gains on this function are not that incredible; but at least it looks nicer in my opinion. The flow of data can be more easily understood and the nesting of operations
is under control. On the contrary, our previous <code>character_map</code> and <code>mess</code> functions got great to immeasurable gains:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  character_map(Pid, MapName, Credentials, Connection) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      Result <span style="color:#f92672">=</span> do([error_m ||
</span></span><span style="display:flex;"><span>		      Character <span style="color:#f92672">&lt;-</span> database:<span style="color:#a6e22e">retrieve_character</span>(Credentials, Connection),
</span></span><span style="display:flex;"><span>		      Map <span style="color:#f92672">&lt;-</span> database:<span style="color:#a6e22e">retrieve_map</span>(MapName, Connection),
</span></span><span style="display:flex;"><span>		      return({Character, Map})]),
</span></span><span style="display:flex;"><span>      Pid <span style="color:#f92672">!</span> Result.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-erlang" data-lang="erlang"><span style="display:flex;"><span>  mess(..., Connection) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      do([postgres_m ||
</span></span><span style="display:flex;"><span>	     UnprocessedMap <span style="color:#f92672">&lt;-</span> {Dimensions, select},
</span></span><span style="display:flex;"><span>	     {ok, {Width, Height}} <span style="color:#f92672">=</span> check_dimensions(UnprocessedMap),
</span></span><span style="display:flex;"><span>	     UnprocessedTiles <span style="color:#f92672">&lt;-</span> {Tiles, select},
</span></span><span style="display:flex;"><span>	     ProcessedTiles <span style="color:#f92672">=</span> lists:<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">fun</span> transform_tile<span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>, database_utils:<span style="color:#a6e22e">columns_and_rows</span>(UnprocessedTiles)),
</span></span><span style="display:flex;"><span>	     UnprocessedObjects <span style="color:#f92672">&lt;-</span> {Objects, select},
</span></span><span style="display:flex;"><span>	     ProcessedObjects <span style="color:#f92672">=</span> lists:<span style="color:#a6e22e">map</span>(<span style="color:#66d9ef">fun</span> transform_object<span style="color:#f92672">/</span><span style="color:#ae81ff">1</span>, database_utils:<span style="color:#a6e22e">columns_and_rows</span>(UnprocessedObjects)),
</span></span><span style="display:flex;"><span>	     Quantity <span style="color:#f92672">=</span> Width <span style="color:#f92672">*</span> Height,
</span></span><span style="display:flex;"><span>	     <span style="color:#66d9ef">if</span> (length(ProcessedTiles) <span style="color:#f92672">==</span> Quantity) <span style="color:#f92672">and</span> (length(ProcessedObjects) <span style="color:#f92672">==</span> Quantity) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>		     return(#{tiles <span style="color:#f92672">=&gt;</span> ProcessedTiles,
</span></span><span style="display:flex;"><span>			      objects <span style="color:#f92672">=&gt;</span> ProcessedObjects,
</span></span><span style="display:flex;"><span>			      width <span style="color:#f92672">=&gt;</span> Width,
</span></span><span style="display:flex;"><span>			      height <span style="color:#f92672">=&gt;</span> Height});
</span></span><span style="display:flex;"><span>		(length(ProcessedTiles) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">or</span> (length(ProcessedObjects) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>		     fail(<span style="color:#e6db74">&#34;Map can&#39;t be instantiated!&#34;</span>);
</span></span><span style="display:flex;"><span>		true <span style="color:#f92672">-&gt;</span> fail(<span style="color:#e6db74">&#34;Mismatch between dimensions, tiles and objects!&#34;</span>)
</span></span><span style="display:flex;"><span>	     <span style="color:#66d9ef">end</span>]).
</span></span></code></pre></div><h2 id="the-trade-off-awakens">The Trade-Off Awakens</h2>
<p>Curious readers may go to the source code and undercover the secrets behind these transformations. Let me tell you upfront that non-ideal code
was necessary to make this happen given Erlang&rsquo;s constraints and how <code>erlando</code> works.</p>
<p>The implementation of the <code>postgres_m</code> monad is rather unsafe and totally exploits the fact that this is a <em>parser extension</em> <strong>and</strong> that this is
a dynamically typed language. The final result is a monad that <em>can</em> blow up and definitely should trigger most Haskellers out there. From a Haskell
perspective, we can&rsquo;t say that the <em>implementation</em> of monads in Erlang using <code>erlando</code> is feature-equivalent with Haskell&rsquo;s &ndash; a judgement that I share.</p>
<p>Achieving perfection, however, was never my intention. My goal was to demonstrate how an abstraction can fullfil requirements even if some annoyance
appears and make its use inconvenient. The understanding of the problem <strong>and</strong> the abstraction (monads in this case) was the key factor for me to pursue
with this solution, regardless of how ugly it was. Fortunately, in this case, there was a way to get around the barrier of use (<code>erlando</code> saved our day)
and now using the chosen abstraction does not culminate in a heavy trade-off on readability.</p>
<p>Even more attentive Erlang enthusiasts may point out that the original version of <code>erlando</code> supported <em>monad transformers</em> &ndash; something that is
absent from Lyceum at the moment of writing this post. Usually, this is one of the main complaints when using monads: their composition via
transformers is for sure non-ideal, to say the least. Solutions to this problem ended up producing <a href="https://tech.fpcomplete.com/haskell/library/rio/">RIO</a> and <a href="https://en.wikipedia.org/wiki/Effect_system">effect systems</a>.</p>
<p>The counter to this concern is twofold: this is <strong>not</strong> Haskell and we <strong>don&rsquo;t</strong> have to use transformers. Because we are using Erlang, the idea that we are
&ldquo;locked in a monad and need to go back and forth using lifts&rdquo; is a non-issue, something that, for better or for worse, is due to the way we are achiving
monads in the code (parser extension + dynamic typing). Hence, this allows us to use do-notation <strong>only</strong> where it makes a huge different, keeping everything
else untouched. Identifying where to use it is something that practice can refine, alongside establishing some common conventions, e.g., you should <em>always</em>
use it when doing a sequence of PGSQL queries in Lyceum, etc. Even if someday we ended up adding transformers to our backend code, the same rules apply: Erlang
is not Haskell and we gotta choose wisely when to use it.</p>
<h2 id="conclusions">Conclusions</h2>
<p>A common mistake people commit in our industry is to conflate an abstraction or idea with its implementation. They notice
that a particular implementation is problematic and generalize it to not only other alternative implementations (usually without
the proper research) but then the craziness goes all the way up to the idea itself. Wrong or underperforming implementations tints
the entire abstraction under a negative light. That is the recipe for a long-lasting trauma, that routes itself on a kingdom of
sand, raised by a bad experience with a vendor/language/hardware.</p>
<p>The ability to separate abstractions and their gains/loses (by themselves) from their implementation counterparts is getting extinct.
monads are way bigger than what Haskell offers it &ndash; we just saw it being done in Erlang, and further you can see all the way from
hints to full behavior of monads in various degrees in other languages, e.g., Erlang, Clojure, F#, OCaml, Rust just to name a few. After thinking
for a while, one starts to get signs of monads being a generalization of <a href="https://en.wikipedia.org/wiki/Continuation-passing_style">CPS</a>; something that opens your mind and completely debunks the idea
that it is tied to Haskell and it should be treated as a Haskell-exclusive thing. There is a difference between a community having a heavier stance on an
abstraction and talking more about it, and it being owned by that community. Just like it does not matter how much the PGSQL/SQLite/Oracle communities
talk about DBMSs, none of them will ever own the idea of the Relational Model, Haskellers can have decades of monadic conversations and it won&rsquo;t make the
abstraction theirs.</p>
<p>This journey not only improved my Erlang code, but it solidified the notion that an idea may be the appropriate one but you may be limited
by the available technologies your ecosystem provides, and thus you may have to surrender the <em>better</em> idea just because of that limiting factor. The trade-offs may be
too heavy to bear, and it is necessary to properly let go of it knowing what is being left on the table. You are <em>choosing</em> to not persue it for
various reasons (cost reasons, efficiency reasons, staff reasons, etc) being aware of the consequences of doing so. Lyceum&rsquo;s case was the one in which the abstraction
that solves the problem was reinvigorated because of a library diminishing one of the trade-offs; namely readability.</p>
</div>
</article>

    <hr />
    <p class="articleTagsContainer">
        <span>ï€« </span>
        <strong>Tags:</strong>
        
            <a
                
                href="/tags/technical">#technical</a>
        
    </p>






                    </main><footer>
    <hr />

<p><small>
        2024 &copy; 
    </small></p>
    <p><small>
        <a href='https://gitlab.com/gabmus/hugo-ficurinia'>Ficurinia theme</a> for <a href='https://gohugo.io'>Hugo</a> by <a href='https://gabmus.org'>Gabriele Musco</a>. Licensed under <a href='https://www.gnu.org/licenses/agpl-3.0.html'>GNU AGPLv3</a>.
    </small></p>
</footer>
</div>
            </div>
        </div>


</body>
</html>
